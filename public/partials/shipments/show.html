<div class="container">
  <div class="row">
    <div class="col-md-12">
      <chain-panel panel-title='Errors' panel-message="eh.errorMessage" panel-type='alert-danger'></chain-panel>
    </div>
  </div>
</div>
<chain-loading-wrapper loading-flag='{{loadingFlag}}'>
  <div class='container'>
    <div ng-show='shp.shp_canceled_date' class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-danger">
            Shipment Canceled
          </div>
          <div class="card-body">
            This shipment was cancelled on {{shp.shp_canceled_date}} by {{shp.shp_canceled_by_fullname}}.
          </div>
          <div class="card-footer text-right" ng-show='shp.permissions.can_uncancel'>
            <button class='btn btn-sm' ng-click='uncancelShipment(shp)'>Undo Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row"> <!-- start ship header -->
      <div class="col-md-4">
        <chain-view-edit edit-if='shp.permissions.can_edit' view-template='/partials/shipments/header_view.html' edit-template='/partials/shipments/header_edit.html'
          panel-title='Shipment' panel-class='card' before-edit='prepShipmentHeaderEdit(shp)' on-save='saveShipment(header)'></chain-view-edit>
      </div>
      <div class="col-md-4">
        <chain-view-edit edit-if='shp.permissions.can_edit' view-template='/partials/shipments/booking_view.html' edit-template='/partials/shipments/booking_edit.html'
          panel-title='Booking' panel-class='card' before-edit='prepBookingEditObject(shp)' on-save='saveShipment(booking)'></chain-view-edit>
        <chain-view-edit edit-if='shp.permissions.can_edit' view-template='/partials/shipments/parties_view.html' edit-template='/partials/shipments/parties_edit.html'
          panel-title='Parties' panel-class='card' before-edit='prepPartiesEditObject(shp)' on-save='saveShipment(partiesEditObj)'></chain-view-edit>
        <add-address-modal shipment-id="shp.id"></add-address-modal>
      </div>
      <div class="col-md-4">
        <chain-view-edit edit-if='shp.permissions.can_edit' view-template='/partials/shipments/tracking_view.html' edit-template='/partials/shipments/tracking_edit.html'
          panel-title='Tracking' panel-class='card' before-edit='prepTrackingEditObject(shp)' on-save='saveShipment(tracking)'></chain-view-edit>
        <chain-view-edit edit-if="shp.permissions.can_edit" view-template="/partials/shipments/delay_reason_view.html" edit-template="/partials/shipments/delay_reason_edit.html"
                         panel-title="Delay Reason Codes" panel-class="card" before-edit="prepDelayReasonObject(shp)" on-save='saveShipment(delay)'></chain-view-edit>
      </div>
    </div> <!-- end ship header -->
    <hr />
    <div class="row">
      <div class="col-md-8"> <!--start comments-->
        <chain-comment parent-object='shp' module-type='Shipment'></chain-comment>
      </div>  <!--end comments -->
      <div class="col-md-4">  <!--start attachments-->
        <div chain-attachment-panel attachable="shp" attachable-type='Shipment' attachable-id='{{shp.id}}' can-attach='shp.permissions.can_attach' attachments="shp.attachments"></div>
      </div> <!--end attachments-->
    </div>
    <hr />
    <div class="row"> <!-- start container section -->
      <div class="col-md-12">
        <div class="card">
          <div class="card-header vandegrift-header">Containers</div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th scope="col">{{label('con_container_number')}}</th>
                  <th scope="col">{{label('con_container_size')}}</th>
                  <th scope="col">{{label('con_seal_number')}}</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                  <tr ng-repeat='con in shp.containers'>
                    <td>{{con.con_container_number}}</td>
                    <td>{{con.con_container_size}}</td>
                    <td>{{con.con_seal_number}}</td>
                    <td ng-show='$parent.shp.permissions.can_edit' class="text-right">
                      <button class="btn btn-danger btn-sm" title='{{con.con_shipment_line_count > 0 ? "Remove lines from container first." : "Delete"}}' ng-disabled='con.con_shipment_line_count > 0' ng-click='$parent.deleteContainer($parent.shp,con)'><i class="fa fa-trash"></i></button>
                      <button class="btn btn-outline-dark btn-sm" title='Edit' ng-click='$parent.editContainer(con)' data-toggle='modal' data-target='#mod_new_container'><i class="fa fa-edit"></i></button>
                    </td>
                  </tr>
              </tbody>
            </table>
          </div>
          <div ng-show='shp.permissions.can_edit' class="card-footer text-right">
            <button class='btn btn-sm btn-success' data-toggle='modal' data-target='#mod_new_container' ng-click='editContainer()'><i class='fa fa-plus'></i></button>
          </div>
        </div>
      </div>
      <div class="modal fade" id='mod_new_container' tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Container</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="nc_con_container_number">{{label('con_container_number')}}</label>
                <input type="text" class='form-control' id='nc_con_container_number' ng-model="containerToEdit.con_container_number">
              </div>
              <div class="form-group">
                <label for="nc_con_container_size">{{label('con_container_size')}}</label>
                <input type="text" class='form-control' id='nc_con_container_size' ng-model="containerToEdit.con_container_size">
              </div>
              <div class="form-group">
                <label for="nc_con_seal_number">{{label('con_seal_number')}}</label>
                <input type="text" class='form-control' id="nc_con_seal_number" ng-model="containerToEdit.con_seal_number">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" ng-click='saveContainer(shp,containerToEdit)' data-dismiss="modal">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- end container section-->
    <hr />
    <div class="card">
      <div class="card-header vandegrift-header">Lines</div>
      <div class="card-body p-0">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li role="presentation" class="nav-item">
              <a class="nav-link active" data-target="#line_summary" aria-controls="line_summary" role="tab" data-toggle="tab">Summary</a>
            </li>
            <li role="presentation" class="nav-item">
              <a class="nav-link" ng-click="shipmentLinesSelected(shp)" data-target="#line_detail" aria-controls="line_detail" role="tab" data-toggle="tab">Manifest Detail</a>
            </li>
            <li role="presentation" class="nav-item">
              <a class="nav-link" ng-click="bookingLinesSelected(shp)" data-target="#booking_detail" aria-controls="booking_detail" role="tab" data-toggle="tab">Booking Detail</a>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="line_summary">
              <chain-ship-detail-summary shipment='shp'></chain-ship-detail-summary>
            </div>
            <div role="tabpanel" class="tab-pane" id="line_detail">
              <div class="row">  <!--start lines section -->
                <div class='col-md-12' ng-hide='shp.lines.length >= 0'>
                  <div class='loader'>Loading</div>
                </div>
                <div class="col-md-12" ng-show='shp.lines.length >= 0'>
                  <div class="card" ng-show='shp.lines.length == 0'>
                    <div class="card-body text-center">This shipment doesn't have any lines.</div>
                  </div>
                  <table class='table table-striped' ng-show='shp.lines.length > 0'>
                    <thead>
                      <tr>
                        <th>Line #</th>
                        <th>Product</th>
                        <th>Order Number - Line</th>
                        <th>Quantity</th>
                        <th>Cartons</th>
                        <th>Volume (CBMS)</th>
                        <th>Gross Weight (KGS)</th>
                        <th>Container</th>
                        <th ng-show='shp.permissions.can_edit'></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat="ln in shp.lines" ng-class="{'danger':ln._destroy}">
                        <td>{{ln.shpln_line_number}}</td>
                        <td>{{ln.shpln_puid}}</td>
                        <td>
                          <div ng-repeat='ol in ln.order_lines'>
                            <a href='/orders/{{ol.order_id}}'>{{shipmentLineOrderNumber(ol)}} - {{ol.ordln_line_number}}</a>
                          </div>
                        </td>
                        <td>
                          {{ln.shpln_shipped_qty}}
                        </td>
                        <td>
                          {{ln.shpln_carton_qty}}
                        </td>
                        <td>
                          {{ln.shpln_cbms}}
                        </td>
                        <td>
                          {{ln.shpln_gross_kgs}}
                        </td>
                        <td>
                          {{ln.shpln_container_number}}
                        </td>
                        <td ng-show='shp.permissions.can_edit' class='text-right'>
                          <button ng-show='shp.permissions.can_add_remove_shipment_lines' class="btn btn-sm btn-danger" title="Delete Line" ng-click="deleteShipmentLine($parent.shp,ln)"><i class="fa fa-trash"></i></button>
                          <button class='btn btn-sm btn-outline-dark' title='Edit Line' ng-click='prepShipmentLineEditObject(ln)' data-toggle='modal' data-target='#mod_edit_line'><i class='fa fa-edit'></i></button>
                          <button class='btn btn-sm btn-outline-dark' title='Show Parties' ng-click='prepPartiesModal(ln)' data-toggle='modal' data-target='#mod_shpln_parties'><i class='fa fa-user'></i></button>
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr ng-show='shp.permissions.can_add_remove_shipment_lines && $parent.shp.lines && $parent.shp.lines.length > 0'>
                        <td colspan="4"></td>
                        <td style="tpadding-top: 10px"><button class="btn btn-sm btn-outline-dark" title="Opens a dialog box to select PO for removal" data-toggle='modal' data-target='#mod_remove_po' data-backdrop="static"><i class="fa fa-edit"></i> Remove PO</button></td>
                        <td style="tpadding-top: 10px"><button class="btn btn-sm btn-danger" title="Immediately delete all lines" ng-click="deleteAllLines($parent.shp)"><i class="fa fa-trash"></i> Delete All Lines</button></td>
                        <td colspan="3"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
              <div ng-if="shp.lines" class="modal fade" id="mod_remove_po" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Remove PO</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <p>This will remove all lines associated with a selected PO.</p>
                      <form>
                        <div class="form-group">
                          <select ng-model="remove_shp_ord" class="form-control" ng-options="order.order_number for order in uniqueOrderOptions(shp.lines) track by order.order_id">
                            <option value="">Select Purchase Order</option>
                          </select> 
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button type="button" ng-disabled="!remove_shp_ord" class="btn btn-danger" ng-click="removePO(shp,remove_shp_ord)">Remove</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal fade" id='mod_edit_line' tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Edit Line</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                      <div class="form-group">
                        <label for="shpln_shipped_qty">Quantity</label>
                        <input type="number" class='form-control' id='shpln_shipped_qty' ng-model="lineToEdit.shpln_shipped_qty">
                      </div>
                      <div class="form-group">
                        <label for="shpln_carton_qty">Cartons</label>
                        <input type="number" class='form-control' id='shpln_carton_qty' ng-model="lineToEdit.shpln_carton_qty">
                      </div>
                      <div class="form-group">
                        <label for="shpln_cbms">CBMs</label>
                        <input type="number" class='form-control' id='shpln_cbms' ng-model="lineToEdit.shpln_cbms">
                      </div>
                      <div class="form-group">
                        <label for="shpln_gross_kgs">Gross KGS</label>
                        <input type="number" class='form-control' id='shpln_gross_kgs' ng-model="lineToEdit.shpln_gross_kgs">
                      </div>
                      <div class="form-group">
                        <label for="shpln_container_uid">Container</label>
                        <select ng-model='lineToEdit.shpln_container_uid' id='shpln_container_uid' class='form-control' ng-options='c.con_uid as c.con_container_number for c in shp.containers'>
                          <option></option>
                        </select>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" ng-click='saveShipmentLine(shp,lineToEdit)' data-dismiss="modal">Save changes</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal fade" id='mod_shpln_parties' tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header"><h2 class="modal-title">Parties for Line {{partyLine.shpln_line_number}}</h2></div>
                    <div class="modal-body">
                      <address-expander ng-show="!edit" title="Manufacturer"
                                        address-name="partyLine.shpln_manufacturer_address_name"
                                        full-address="partyLine.shpln_manufacturer_address_full_address">
                              </address-expander>
                      <label ng-show="edit" for="modal_mfg_edit">Manufacturer</label>
                      <address-book-autocomplete ng-show="edit" id="modal_mfg_edit" initial-value="partyLine.shpln_manufacturer_address_name" address-id-attribute="partyLine.shpln_manufacturer_address_id"></address-book-autocomplete>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-primary float-left" ng-click="edit = !edit" ><i class="fa fa-{{edit ? 'unlock-alt' : 'lock'}}"></i></button>
                      <button type="button" class="btn btn-primary" ng-click='edit = false; saveShipmentLine(shp,partyLine)' ng-show="edit" data-dismiss="modal">Save</button>
                      <button type="button" class="btn btn-secondary" ng-click="edit = false;" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            </div> <!--end lines section -->
            <div role="tabpanel" class="tab-pane" id="booking_detail">
              <div class="row"> <!--start lines section -->
                <div class='col-md-12' ng-hide='shp.booking_lines.length >= 0'>
                  <div class='loader'>Loading</div>
                </div>
                <div class="col-md-12" ng-show='shp.booking_lines.length >= 0'>
                  <div class="card" ng-show='shp.booking_lines.length == 0'>
                    <div class="card-body text-center">This shipment doesn't have any booking lines.</div>
                  </div>
                  <table class='table table-striped' ng-show='shp.booking_lines.length > 0'>
                    <thead>
                    <tr>
                      <th>Line #</th>
                      <th>Product</th>
                      <th ng-bind-html="shp.conditionalFields.orderNumber.label"></th>
                      <th>Container<br>Size</th>
                      <th ng-bind-html="shp.conditionalFields.orderQuantity.label"></th>
                      <th>Booked Quantity</th>
                      <th ng-bind-html="shp.conditionalFields.percentageBooked.label"></th>
                      <th>Cartons</th>
                      <th>Volume<br>(CBMS)</th>
                      <th>Gross Weight<br>(KGS)</th>
                      <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="ln in shp.booking_lines" ng-class="{'danger':ln._destroy}">
                      <td>{{ln.bkln_line_number}}</td>
                      <td>{{ln.bkln_puid}}</td>
                      <td>
                        <a ng-href='/orders/{{ln.bkln_order_id}}'>{{ln[shp.conditionalFields.orderNumber.fieldName]}}</a>
                      </td>
                      <td>
                        {{ln.bkln_container_size}}
                      </td>
                      <td>
                        {{ln[shp.conditionalFields.orderQuantity.fieldName]}}
                      </td>
                      <td>
                        {{ln.bkln_quantity}}
                      </td>
                      <td>
                        {{ln[shp.conditionalFields.percentageBooked.fieldName] | number:2}}%
                      </td>
                      <td>
                        {{ln.bkln_carton_qty}}
                      </td>
                      <td>
                        {{ln.bkln_cbms}}
                      </td>
                      <td>
                        {{ln.bkln_gross_kgs}}
                      </td>
                      <td class='text-right'>
                        <button ng-show='shp.permissions.can_add_remove_booking_lines' class="btn btn-sm btn-danger" title="Delete Line" ng-click="deleteBookingLine($parent.shp,ln)"><i class="fa fa-trash"></i></button>
                        <button ng-show='shp.permissions.can_add_remove_booking_lines' class='btn btn-outline-dark btn-sm' title='Edit Line' ng-click='prepShipmentLineEditObject(ln)' data-toggle='modal' data-target='#mod_edit_booking_line'><i class='fa fa-edit'></i></button>
                      </td>
                    </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="11" style="text-align:center; padding-top: 10px"><button ng-show='shp.permissions.can_add_remove_booking_lines && $parent.shp.booking_lines && $parent.shp.booking_lines.length > 0' class="btn btn-sm btn-danger" title="Delete All Lines" ng-click="deleteAllBookingLines($parent.shp)"><i class="fa fa-trash"></i> Delete All Lines</button></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
              <div class="modal fade" id='mod_edit_booking_line' tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Edit Line</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                      <div class="form-group">
                        <label for="bkln_quantity">Quantity</label>
                        <input type="number" class='form-control' id='bkln_quantity' ng-model="lineToEdit.bkln_quantity">
                      </div>
                      <div class="form-group">
                        <label for="bkln_carton_qty">Cartons</label>
                        <input type="number" class='form-control' id='bkln_carton_qty' ng-model="lineToEdit.bkln_carton_qty">
                      </div>
                      <div class="form-group">
                        <label for="bkln_cbms">CBMs</label>
                        <input type="number" class='form-control' id='bkln_cbms' ng-model="lineToEdit.bkln_cbms">
                      </div>
                      <div class="form-group">
                        <label for="bkln_gross_kgs">Gross KGS</label>
                        <input type="number" class='form-control' id='bkln_gross_kgs' ng-model="lineToEdit.bkln_gross_kgs">
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" ng-click='saveBookingLine(shp,lineToEdit)' data-dismiss="modal">Save changes</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <nav id="action_bar" class='navbar navbar-expand-md navbar-light fixed-bottom'>
    <button class="navbar-toggler mb-1" type="button" data-toggle="collapse" data-target="#actionBarCollapse" aria-controls="actionBarCollapse" aria-expanded="false" aria-label="Toggle action bar buttons">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="actionBarCollapse">
      <ul class='navbar-nav' id='nav-action-bar'>
        <li class="nav-item">
          <button ng-show='shp.permissions.can_request_booking' class='btn btn-secondary' ng-click='requestBooking(shp)'>Request Booking</button>
          <button ng-show='shp.permissions.can_approve_booking' class='btn btn-secondary' ng-click='approveBooking(shp)'>Approve Booking</button>
          <button ng-show='shp.permissions.can_confirm_booking' class='btn btn-secondary' ng-click='confirmBooking(shp)'>Confirm Booking</button>
          <button ng-show='shp.permissions.can_revise_booking' class='btn btn-secondary' ng-click='reviseBooking(shp)'>Revise Booking</button>
          <button ng-show='shp.permissions.can_request_cancel' class='btn btn-secondary' ng-click='requestCancel(shp)'>Request Cancel</button>
          <button ng-show='shp.permissions.can_cancel' class='btn btn-secondary' ng-click='cancelShipment(shp)'>Cancel Shipment</button>
          <button ng-show='shp.permissions.can_uncancel' class='btn btn-secondary' ng-click='uncancelShipment(shp)'>Uncancel Shipment</button>
          <button ng-show='shp.permissions.can_add_remove_shipment_lines' class='btn' ng-click='showAddOrder()'>Build Manifest</button>
          <button class = 'btn btn-secondary' ng-click='showHistory(shp)'>History</button>
          <button ng-show='shp.permissions.can_book && shp.permissions.can_add_remove_booking_lines && shp.permissions.enabled_booking_types.length > 0' class='btn btn-secondary' ng-click='showBookOrder()'>Book Now</button>
          <button ng-show='(shp.permissions.can_add_remove_booking_lines || shp.permissions.can_add_remove_shipment_lines) && shp.attachments.length > 0' class='btn btn-secondary' ng-click='showProcessManifest()'>Process Worksheets</button>
          <button ng-show='shp.permissions.can_send_isf' class='btn btn-secondary' ng-click='sendISF(shp)'>Send ISF</button>
          <a class='btn btn-secondary' href="/shipments/{{shp.id}}/download">Download</a>
          <chain-ship-request-booking-button shipment='shp'></chain-ship-request-booking-button>
        </li>
      </ul>
    </div>
  </nav>
</chain-loading-wrapper>

<div class='container'>  
  <div class='modal fade show' role='dialog' id='search-modal' aria-hidden='true'>
    <div class='modal-dialog modal-lg' role='document'>
      <div class='modal-content'>
        <div class='modal-header'>
          <h4 class='modal-title'>Search Results</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class='modal-body'>
          <div class="row" data-qs-panel='qs-Entry' style="margin-bottom: 5px;">
            <div class="col-md-12">
              <h2>Entry</h2>
              <div id='modwrap_Entry'>
                <div class='loader'>loading</div>
              </div>
            </div>
          </div>  
        </div>
      </div>  
    </div>
  </div>
</div>
