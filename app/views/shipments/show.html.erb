<% content_for :javascript do %>
  $(function() {
    $( "#btn_edit" )
      .button()
      .click(function() {
        window.location = '<%=edit_shipment_path(@shipment)%>';
      });
    $( "#item_change_subscription_submit").button();
    $("#mod_subscriptions").dialog({autoOpen:false,title:"Subscriptions",
      buttons:{"Subscribe":function() {$("#frm_sub").submit();}}});
    $("#btn_subscriptions")
      .button()
      .click(function() {
        $("#mod_subscriptions").dialog('open');
    });
    $("#mod_edit_line").dialog({autoOpen:false,title:'Edit Line',
      width:'auto',
      buttons:{"Save":function() {$("#frm_edit_line").submit();},
               "Cancel":function() {window.location = '<%=shipment_path(@shipment)%>';}}  
    });
    $("#btn_add_line").button().click(function() {
      $("#mod_edit_line").dialog('open');
    });
    $(".lnk_detail").click(function(ev) {
      ev.preventDefault();
      $(this).parents("tr.shp_line").next().toggle();
    });
    $("#lnk_all_details").click(function(ev) {
      ev.preventDefault();
      $(".shp_line_detail").show();
    });

    <% if @shipment.can_edit?(current_user) && !@line.nil? %>
      $("#mod_edit_line").dialog('open');
    <% end %>
    $("#mod_pack_order").dialog({autoOpen:false,title:'Pack Order',width:'auto',
      buttons:{"Add":function() {$("#frm_pack_order").submit();},
      "Cancel":function() {$("#mod_pack_order").dialog('close');}}
    });
    $("#mod_open_orders").dialog({autoOpen:false,title:'Select Order',width:'auto',
        buttons:{"OK":function() {
          var id = $("#sel_open_orders").val();
          if(id) {
            $("#mod_open_orders").dialog('close');
            openPackOrder(id);
          } else {
            window.alert("Select an order first.")
          }
        },
        "Cancel":function() {$("#mod_open_orders").dialog('close');}}});
    $("#btn_add_order").click(function() {
      $("#mod_open_orders").dialog('open');
      getOpenOrders(function(data) {
        var i;
        if(data.length==0) {
          $("#sel_open_orders").html("<option>No Orders Available</option>");
        } else {
          var opt = "";
          for(i=0;i<data.length;i++) {
            var o = data[i].order;
            opt += "<option value='"+o.id+"'>"+o.order_number+"</option>";
          }
          $("#sel_open_orders").html(opt);
        }
      });
    });
  });
function openPackOrder(id) {
  $("#div_pack_order_content").html("Loading...");
  $("#mod_pack_order").dialog('open');
  getOrder(id,function(data) {
    var h = "";
    var order = data.order
    h += "<div>Pack Order: "+order.order_number+"</div><table class='detail_table'><thead><tr><th>Order Row</th><th>Product</th><th>Ordered</th><th>Shipped</th></tr></thead><tbody>";
    var i;
    for(i=0;i<order.order_lines.length;i++) {
      var line = order.order_lines[i];
      h+="<tr><td><input type='hidden' name='[lines]["+i+"][order_line_id]' value='"+line.id+"'/>"+line.line_number+"</td><td>"+line.product.name+"<input type='hidden' name='[lines]["+i+"][product_id]' value='"+line.product.id+"'/></td><td>"+line.quantity+"</td><td><input type='text' name='[lines]["+i+"][quantity]' /></td></tr>";
    }
    h += "</tbody></table>";
    $("#div_pack_order_content").html(h);
  });
}
<% end %>

<% content_for :action_bar do %>
  <% if @shipment.can_edit?(current_user) %>
    <button id='btn_edit'>Edit</button>
  <%end%> 
  <button id='btn_subscriptions'>Subscriptions<%=ItemChangeSubscription.count(:conditions => {:shipment_id => @shipment.id, :user_id => current_user.id}) == 0 ? '' : "*"%></button>
<% end %>

<div class='content_head'>
	<span class='content_head_label'>Reference:</span>
	<b><%= @shipment.reference %></b>
	<br />
	<span class='content_head_label'>Vendor:</span>
  <b><%= @shipment.vendor.name %></b>
  <br />&nbsp;
</div>
<table class='detail_table'>
  <thead><th>Ship From</th><th>Ship To</th></thead>
  <tbody><tr>
    <td style='width:50%' class='hover'>
      <%=  render :partial => 'addresses/display', :locals => { :ad => @shipment.ship_from, :address_id => 'ship_from_ad' } %>
    </td>
    <td style='width:50%' class='hover'>
      <%=  render :partial => 'addresses/display', :locals => { :ad => @shipment.ship_to, :address_id => 'ship_to_ad' } %>      
    </td>
  </tr></tbody>
</table>
<br />
<table class='detail_table' >
  <thead>
    <tr><th>Attributes</th></tr>
  </thead>
  <tbody>
    <tr>
      <td style='width:50%'>
        <b>Carrier:</b>
        <%= @shipment.carrier_id.nil? ? '' : @shipment.carrier.name %>
        <br />
        <b>Mode:</b>
        <%=@shipment.mode %>
				<%=show_custom_fields @shipment%>
      </td>
    </tr>
  </tbody>
</table>

<table class='detail_table'>
  <thead>
    <tr><th>Row</th><th>Product</th><th>Ship Quantity</th><th>Order Number - Line</th><th><a href='#' id='lnk_all_details'>All Details</a></th>
  </thead>
  <tbody>
    <%@shipment.shipment_lines.order("line_number ASC").each do |line|%>
    <tr class='hover shp_line'>
      <td><%= @shipment.can_edit?(current_user) & !@shipment.locked? ? (link_to line.line_number, edit_shipment_shipment_line_path(@shipment,line)) : line.line_number %></td>
      <td><%=link_to line.product.name.nil? ? line.product.unique_identifier : line.product.name, line.product%></td>
      <td><%=line.quantity%></td>
      <td>
        <%line.order_lines.each do |o|%>
          <%=link_to o.order.order_number, o.order%> - <%=o.line_number%>
        <%end%>
      </td>
      <td>
        <%if has_custom_fields(line) %><a href='#' class='lnk_detail'>Details</a><%end%>
        <%if has_custom_fields(line) && @shipment.can_edit?(current_user)%>
        &nbsp;|&nbsp;
        <%end%>
        <%if @shipment.can_edit?(current_user)%>
        <%=link_to "Delete", shipment_shipment_line_path(@shipment,line), :confirm=>'Are you sure you want to delete this line?', :method=>:delete %>
        <%end%>
      </td>
    </tr>
    <tr class='shp_line_detail' style='display:none;'>
      <td colspan='5' style="padding-left:1em;">
      <%=show_custom_fields line%>
      </td>
    </tr>
    <%end%>
  </tbody>
</table>
<% if @line.nil? && @shipment.can_edit?(current_user)%>
<button id='btn_add_line'>Add Product</button>
<button id='btn_add_order'>Add Order</button>
<% end %>
<% form_line = @line.nil? ? @shipment.shipment_lines.build : @line %>
<div id='mod_edit_line' style='display:none;'>
  <%= form_for([@shipment, form_line], :html=>{:id=>'frm_edit_line'}) do |f| %>
  <table>
    <% form_line.default_line_number%>
    <%=field_row "Line Number", f.text_field(:line_number, "size" => 2) %>
    <%=field_row "Product", f.collection_select(:product_id, @products, :id, :name, {:prompt => "-Select a product"}, {:id=>"edit_line_product"})%>
    <%=field_row "Ship Quantity", f.text_field(:quantity, "size" => 5) %>
    <%=field_row "Unit of Measure", content_tag(:span,(form_line.product.nil? ? '' : form_line.product.unit_of_measure),{:id=>"edit_line_uom"})%>
    <% form_line.order_lines.each do |oline| %>
    <%=field_row "Order / Line", content_tag(:span,"#{oline.order.order_number} - #{oline.line_number}")+hidden_field_tag(:order_line_id,oline.id) %>
    <% end %>
    <%= show_custom_fields form_line, {:form => true, :table=>true}%>
  </table>
  <% end %>
</div>
<div id='mod_open_orders' style='display:none;'>
<div>Select an Order:</div>
<select id='sel_open_orders'><option>Loading...</option></select>
</div>
<div id='mod_pack_order' style='display:none;'>
<%=form_tag(create_multiple_shipment_shipment_lines_path(@shipment), :method=>"post", :id=>"frm_pack_order") do |f|%>
  <div id='div_pack_order_content'></div>
<%end%>
</div>
<%=render :partial => 'shared/comments', :locals => {:commentable => @shipment} %>
<%=render :partial => 'shared/attachments', :locals => {:attachable => @shipment}%>
<div id='mod_subscriptions' style='display:none;'>
  <% 
  change_subs = ItemChangeSubscription.where({:shipment_id => @shipment.id, :user_id => current_user.id})
  if change_subs.length == 0
   @ics = @shipment.item_change_subscriptions.build
   @ics.user = current_user 
  else
   @ics = change_subs[0]
  end 
 %>
 <%= form_for @ics, :html=>{:id=>'frm_sub'} do |ics| %>
    <%= ics.hidden_field :user_id %>
    <%= ics.hidden_field :shipment_id %>
    <%= ics.check_box :app_message %> Message<br />
    <%= ics.check_box :email %> Email<br />
 <% end %>
</div>

