<% content_for :javascript do %>
$(function() {
  $( "#btn_edit" )
    .button()
    .click(function() {
      window.location = '<%=edit_shipment_path(@shipment)%>';
    });
  OpenChain.addClickMap('e','Edit','btn_edit');
  OpenChain.activateHotKeys();
  $( "#item_change_subscription_submit").button();
  $("#mod_subscriptions").dialog({autoOpen:false,title:"Subscriptions",
    buttons:{"Subscribe":function() {$("#frm_sub").submit();}}});
  $("#btn_subscriptions")
    .button()
    .click(function() {
      $("#mod_subscriptions").dialog('open');
  });
});
<% end %>

<% content_for :action_bar do %>
  <% if @shipment.can_edit?(current_user) %>
    <button id='btn_edit'>Edit</button>
  <%end%> 
  <button class='btn_link' link_to='<%=shipments_path%>' key_map='b'>Back To Search</button>
  <button class='btn_link' link_to='<%=history_shipment_path(@shipment)%>' key_map='h'>History</button>
  <% if current_user.edit_commercial_invoices? && CommercialInvoiceMap.count > 0%>
    <button class='btn_link' link_to='<%=make_invoice_shipment_path(@shipment)%>'>Make Commercial Invoice</button>
  <%end%>
  <button id='btn_subscriptions'>Subscriptions<%=ItemChangeSubscription.count(:conditions => {:shipment_id => @shipment.id, :user_id => current_user.id}) == 0 ? '' : "*"%></button>
<% end %>

<div class='content_head'>
	<span class='content_head_label'><%=field_label(:shp_ref)%>:</span>
	<b><%= @shipment.reference %></b>
	<br />
	<span class='content_head_label'><%=field_label(:shp_ven_name)%>:</span>
  <b><%= @shipment.vendor ? @shipment.vendor.name : ''%></b>
  <br />&nbsp;
</div>
<table class='detail_table'>
  <thead><th><%=field_label(:shp_ship_from_name)%></th><th><%=field_label(:shp_ship_to_name)%></th></thead>
  <tbody><tr>
    <td style='width:50%' class='hover'>
      <%=  render :partial => 'addresses/display', :locals => { :ad => @shipment.ship_from, :address_id => 'ship_from_ad' } %>
    </td>
    <td style='width:50%' class='hover'>
      <%=  render :partial => 'addresses/display', :locals => { :ad => @shipment.ship_to, :address_id => 'ship_to_ad' } %>      
    </td>
  </tr></tbody>
</table>
<br />
<div style='width:95%;margin-bottom:10px;'>
<%=render :partial=>'shared/attachments', :locals=>{:attachable=>@shipment}%>
<div class='next_to_attachments'>
<table>
  <tbody>
    <%=field_row field_label(:shp_car_name), (@shipment.carrier_id.nil? ? '' : @shipment.carrier.name)%>
    <%=field_row field_label(:shp_mode), @shipment.mode%>
		<%=show_custom_fields @shipment, {:table=>true}%>
  </tbody>
</table>
</div>
</div>
<table class='detail_table'>
  <thead>
    <tr><th><%=field_label(:shpln_line_number,false)%></th>
    <th><%=field_label(:prod_name,false)%></th>
    <th><%=field_label(:shpln_shipped_qty,false)%></th>
    <th><%=field_label(:ordln_line_number,false)%></th>
    <th><a href='#' id='lnk_all_details'>All Details</a></th>
  </thead>
  <tbody>
    <%@shipment.shipment_lines.order("line_number ASC").each do |line|%>
    <tr class='hover shp_line'>
      <td><%= @shipment.can_edit?(current_user) && !line.locked? ? (link_to line.line_number, edit_shipment_shipment_line_path(@shipment,line)) : line.line_number %></td>
      <td><%=link_to line.product.name.nil? ? line.product.unique_identifier : line.product.name, line.product%></td>
      <td><%=line.quantity%></td>
      <td>
        <%line.order_lines.each do |o|%>
          <%=link_to o.order.order_number, o.order%> - <%=o.line_number%><br />
        <%end%>
      </td>
      <td>
        <%if has_custom_fields(line) %><a href='#' class='lnk_detail'>Details</a><%end%>
        <%if has_custom_fields(line) && @shipment.can_edit?(current_user)%>
        <%end%>
        <%if @shipment.can_edit?(current_user) && !line.locked?%>
          |&nbsp;<%=link_to "Delete", shipment_shipment_line_path(@shipment,line), :confirm=>'Are you sure you want to delete this line?', :method=>:delete %>
        <%end%>
      </td>
    </tr>
    <tr class='shp_line_detail' style='display:none;'>
      <td colspan='5' style="padding-left:1em;">
        <table>
        <%=show_custom_fields line, {:show_prefix=>false,:table=>true}%>
        <%line.commercial_invoice_lines.collect {|invln| invln.commercial_invoice}.uniq.compact.each do |inv|%>
          <%=field_row field_label(:ci_invoice_number,false), link_to(field_value(inv,:ci_invoice_number),inv)%>
        <%end%>
        </table>
      </td>
    </tr>
    <%end%>
  </tbody>
</table>
<%=render :partial => 'shared/pack_lines', :locals=>{:parent=>@shipment, :line=>@line, :products=>@products, :is_sales_order=>false} %>
<%=render :partial => 'shared/comments', :locals => {:commentable => @shipment} %>
<div id='mod_subscriptions' style='display:none;'>
  <% 
  change_subs = ItemChangeSubscription.where({:shipment_id => @shipment.id, :user_id => current_user.id})
  if change_subs.length == 0
   @ics = @shipment.item_change_subscriptions.build
   @ics.user = current_user 
  else
   @ics = change_subs[0]
  end 
 %>
 <%= form_for @ics, :html=>{:id=>'frm_sub'} do |ics| %>
    <%= ics.hidden_field :user_id %>
    <%= ics.hidden_field :shipment_id %>
    <%= ics.check_box :app_message %> Message<br />
    <%= ics.check_box :email %> Email<br />
 <% end %>
</div>

