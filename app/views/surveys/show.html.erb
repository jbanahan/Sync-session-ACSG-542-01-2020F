<%content_for :head_tags do%>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
<%end%>
<%content_for :javascript do%>
  $(function() {
    $("#mod_copy").dialog({autoOpen:false,title:"Confirm Copy",buttons:{
      "OK":function() {window.location="/surveys/<%=@survey.id%>/copy"},"Cancel":function() {$("#mod_copy").dialog('close');}
    }}); 
    $("#btn_cpy").click(function() {$("#mod_copy").dialog('open');});
    $("#btn_show_archived").click(function() {window.location="<%=survey_path @survey%>?show_archived_responses=true"});
  });
  google.load('visualization', '1.0', {'packages':['corechart']});
  var respC = function drawChart() {

    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Rating');
    data.addColumn('number', 'Count');
    data.addRows([
      <%@survey.rating_values.each_with_index do |rv,i|%>
        ['<%=rv%>',<%=@survey.survey_responses.was_archived(false).where(:rating=>rv).count%>],
      <%end%>
      ['Not Rated',<%=@survey.survey_responses.was_archived(false).where("rating is null OR length(rating)=0").count%>]
    ]);

    var options = {'title':'Surveys by Rating',
                   'height':300};
    var chart = new google.visualization.PieChart(document.getElementById('resp_chart'));
    chart.draw(data, options);
  }
  google.setOnLoadCallback(respC);
  var statC = function drawchart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Status');
    data.addColumn('number', 'Count');
    data.addRows([
      <%[:incomplete, :needs_rating, :rated].each do |st|
        status = SurveyResponse::STATUSES[st]
        isRated = status == SurveyResponse::STATUSES[:rated]
      %>
      ['<%=status%>',<%=@survey.survey_responses.was_archived(false).where(:status=>status).count%>]<%=isRated ? "" : ","%>
      <%end%>
    ]);
    var options = {'title':'Surveys by Status',
                   'height':300};
    var chart = new google.visualization.PieChart(document.getElementById('stat_chart'));
    chart.draw(data, options);
  }
  google.setOnLoadCallback(statC);
<%end%>
<%content_for :action_bar do%>
  <% if !@survey.archived? %>
    <% unless @survey.locked? %>
      <button class='btn_link' link_to='<%=edit_survey_path @survey%>' key_map='e'>Edit</button>
    <% end%>
    <button class='btn_link' link_to='<%=show_assign_survey_path @survey%>' key_map='a'>Assign</button>
    <% if current_user.view_surveys? && @survey.company_id == current_user.company_id %>
      <button class='btn_link' link_to='<%=toggle_subscription_survey_path @survey%>' key_map='t'>
        <%= @survey.survey_subscriptions.where(:user_id => current_user).empty? ? "Subscribe" : "Unsubscribe" %>
      </button>
    <% end %>
    <% if @survey.can_edit?(current_user)%>
      <button id='btn_cpy'>Copy Survey</button>
      <%= button_to "Archive Survey", {action: :archive, id: @survey.id}, method: :put, class:'btn navbar-btn btn-default', form_class:'inline-button-to'%>
    <% end %>
  <% elsif @survey.can_edit?(current_user) %>
      <%= button_to "Restore Survey", {action: :restore, id: @survey.id}, method: :put, class:'btn navbar-btn btn-default', form_class:'inline-button-to'%>
  <% end %>
  
  <% if @survey.can_edit?(current_user) && @survey.survey_responses.was_archived(true).count > 0 %>
    <button id='btn_show_archived'>Show Archived Responses</button>
  <% end %>
<%end%>
<% if @survey.archived? %>
<div class="alert alert-warning"><p>This survey has been archived.  You may not change anything on archived surveys.  Use the 'Restore Survey' button to change this survey to active.</p></div>
<% end %>
<h1>
  <%=@survey.name%>
  <%if !@survey.system_code.blank?%>
    <small title='System tracking code.'>(<%=@survey.system_code%>)</small>
  <%end%>
</h1>

<div id='stat_chart' style='text-align:center; width:45%; margin:0; float:right;'></div>
<div id='resp_chart' style='text-align:center; width:45%; margin:0;'></div>
<div style='clear:both'></div>
<h3>Survey Responses</h3>
<%=render :partial=>'response_status', locals: {survey_responses: @survey_responses, show_archive_control: true} %>
<%- archived = @survey.survey_responses.was_archived(true).count -%> 
<% if @show_archived && archived > 0 %>
<h3>Archived Responses</h3>
<%=render :partial=>'response_status', locals: {survey_responses: @survey.survey_responses.was_archived(true).order('survey_responses.updated_at DESC'), show_restore_control: true} %>
<% else %>
<p><%= "#{archived} survey #{"response".pluralize(archived)} #{"has".pluralize(archived)}"%> been archived.</p>
<% end %>

<h2>Questions</h2>
<table class='detail_table table table-striped'>
  <thead><tr><th>Question</th><th>Answered</th>
  <%@survey.rating_values.each do |rv|%>
    <th><%=rv%></th>
  <%end%>
  </tr></thead>
  <tbody>
    <%@survey.questions.each do |q|%>
      <tr class='hover'>
        <td><%=RedCloth.new(q.content).to_html.html_safe%></td>
        <td><%=@survey.answers.where(:question_id=>q.id).where("survey_responses.submitted_date is not null").merge(SurveyResponse.was_archived(false)).count%></td>
        <%@survey.rating_values.each do |rv|%>
          <td><%=@survey.answers.where(:question_id=>q.id,:rating=>rv).merge(SurveyResponse.was_archived(false)).count%></td>
        <%end%>
      </tr>
    <%end%>
  </tbody>
</table>

<div id='mod_copy' style='display:none;'>
  <p><em>Are you sure you want to make a new version of this survey?</em></p>
  <p>If you are trying to issue the survey to a user, use the Assign button instead.</p>
</div>
