<% content_for :javascript do %>
  var importedFilePreviewLoaded = false;
  $(function() {
    <% unless @search_run.blank? %>
      OCSearch.init(<%=@search_run.total_objects%>,<%=@search_run.id%>);
    <% end %>
    <% unless @bulk_actions.blank?%>
      <% @bulk_actions.each do |k,v| %>
        OCSearch.addBulkHandler('<%="btn_bulk_#{k.gsub(/ /,"").underscore}"%>','<%=send(v)%>');
      <% end %>
    <% end%>
    <% if @imported_file.deletable? && @imported_file.can_delete?(current_user)%>
    $("#btn_delete").button();
    OpenChain.addClickMap('d','Delete','btn_delete');
    <%end%>
    <% unless @imported_file.search_setup.nil? %>
    $("#btn_process").click(function() {$("#mod_loading").dialog('open');});
    $("#btn_download").click(function() {window.location='<%=download_imported_file_path @imported_file%>';});
    $("#mod_loading").dialog({autoOpen:false,width:300,title:"Preview Loading",modal:true,
      open:function() {
        if(!importedFilePreviewLoaded) {
          $.getJSON('<%=preview_imported_file_path @imported_file%>',function(data) {
            if(data.error) {
              $("#mod_loading").dialog('close');
              $("#mod_error").dialog('open');         
            } else {
              var str = "<ul>";
              for(var i=0;i<data.length;i++) {
                str += "<li>"+data[i]+"</li>";
              }
              str += "</ul>";
              $("#preview_content").html(str);
              importedFilePreviewLoaded = true;
              $("#mod_loading").dialog('close');
              $("#mod_preview").dialog('open');
            }
          });
        } else {
          $("#mod_loading").dialog('close');
          $("#mod_preview").dialog('open');
        }
      }
    });
    $("#mod_preview").dialog({autoOpen:false,width:400,title:"Preview",modal:true,buttons:{
      "Go":function() {
        $("#mod_preview").dialog('close');
        $("#mod_processing").dialog('open');
        window.location = '<%=process_file_search_setup_imported_file_path(@imported_file.search_setup,@imported_file)%>';
      },
      "Cancel":function() {$("#mod_preview").dialog('close');}
      }
      });
    $("#mod_error").dialog({autoOpen:false,width:300,title:"Error Reading File",modal:true,buttons:{"OK":function() {$("#mod_error").dialog('close');}}});
    $("#mod_processing").dialog({autoOpen:false,width:300,title:"Processing",
      modal:true,closeOnEscapse:false,close:function() {$("#mod_processing").dialog('open')}});
      <%if @file_import_result.nil?%>
        $("#mod_loading").dialog('open');
      <%end%>
    <% end %>
    $("#mod_download_items").dialog({autoOpen:false,width:600,title:"Download Items",modal:true,buttons:{"OK":function(){$("#frm_di").submit(); },"Cancel":function() {$("#mod_download_items").dialog('close');}}});
    $("#filter_download").change(function() {
      if($(this).is(":checked")) {
        var fields = [];
        <%ModelField.sort_by_label(@imported_file.core_module.model_fields_including_children.values).each do |mf| %>
          fields.push({"uid":'<%=escape_javascript mf.uid.to_s%>',"dtype":'<%=escape_javascript mf.data_type.to_s%>',"label":'<%=escape_javascript mf.label%>'});
        <%end%>
        OCSearch.addSearchCriterion($("#download_items_crits"),fields,new Date().getTime(),null,null,null,false);
      } else {
        $("#download_items_crits").html("");
      }
    });
    $("input[name='send_to']").change(function() {
      if($("#di_email_radio").is(":checked")) {
        $("#di_email_box").show();
      } else {
        $("#di_email").val("");
        $("#di_email_box").hide();
      }
    });
    $("#btn_di").click(function() {$("#mod_download_items").dialog('open');});
  });
<% end %>

<% content_for :action_bar do %>
  <% unless @imported_file.search_setup.nil? %>
    <button id='btn_process'>Process</button>
  <% end %>
  <% if @imported_file.deletable? && @imported_file.can_delete?(current_user)%>
    <%=button_to('Delete', imported_file_path(@imported_file),:method=>:delete, :confirm=>"Are you sure?", :id=>"btn_delete")%>
  <% end %>
  <% unless @file_import_result.nil?%>
    <button class='btn_link' link_to='<%=file_import_result_path(@file_import_result)%>'>Log</button>
    <button id='btn_di'>Download Items</button>
  <%end%>
  <button id='btn_download'>Download Original</button>
  <%unless @bulk_actions.blank?%>
    <%@bulk_actions.each do |k,v|%>
      <button id='<%="btn_bulk_#{k.gsub(/ /,"").underscore}"%>'><%=k%></button>
    <%end%>
  <%end%>
<% end %>
<table>
  <tr>
    <td width='50%' style='vertical-align:top;'>
      <table>
        <%=field_row "File Name", @imported_file.attached_file_name %>
        <%=field_row "Uploaded At", @imported_file.created_at %>
        <%=field_row "Uploaded By", @imported_file.user ? @imported_file.user.full_name : ""%>
      </table>
    </td>
    <td width='50%' style='vertical-align:top;'>
      <table>
        <%=field_row "Last Processed", @file_import_result.nil? ? "Never" : (@file_import_result.finished_at.nil? ? "Processing" : @file_import_result.finished_at) %>
        <%=field_row "File Rows", @file_import_result.nil? ? "" : @file_import_result.change_records.size %>
        <%=field_row "Records", @search_run.nil? ? "" : @search_run.total_objects %>
        <% if @file_import_result%>
          <% error_count = @file_import_result.error_count%>
          <% if error_count>0%>
            <%=field_row "Errors", link_to(pluralize(error_count,"error"), @file_import_result, :class=>"error")%>
          <%end%>
        <%end%>
      </table>
    </td>
  </tr>
</table>
<div id='main_search_cont'>
<div id='bulk_message'></div>
<%unless @file_import_result.nil?%>
<table class='detail_table' id='result_table'>
  <thead>
    <% unless @bulk_actions.blank?%><th><input type='checkbox' id='chk_sel_all' /></th><%end%>
    <th>Actions</th>
    <%@columns.each do |col|%>
      <th><%=col.find_model_field.label%></th>
    <%end%>
  </thead>
  <tbody>
    <% cursor = 0 %>
    <% last_object = nil %>
    <%GridMaker.new(@changed_objects,@columns,[],@imported_file.core_module.default_module_chain).go do |row,obj|%>
      <tr class='hover <%=(!last_object.nil? && obj!=last_object) ? "search_row_break" : ""%>'>
        <% if !@bulk_actions.blank? %><td><%=obj!=last_object ? "<input type='checkbox' pk='#{obj.id}' />".html_safe : ""%></td><% end %>
        <td>
          <% if obj!=last_object %>
            <%=render :partial=>'shared/search_links', :locals=>{:obj=>obj,:cursor=>cursor}%> 
            <%cursor += 1%>
          <% end %>
        </td>
        <% row.each do |r| %>
        <td><%=r.blank? ? (!r.nil? && r.is_a?(FalseClass) ? "false" : "&nbsp;".html_safe) : r%></td>
        <% end %>
      </tr>
      <%last_object = obj%>
    <%end%>
  </tbody>
</table>
  <% if @max_pages>1%>
    <div class='pagination'>
     <%if @target_page>0%><%=link_to "&#8592;Previous".html_safe, imported_file_path(@imported_file,:page=>@target_page-1)%><%end%> 
     <%(0..@max_pages-1).each do |p|%>
        <%if @target_page!=p%><%=link_to p+1, imported_file_path(@imported_file,:page=>p)%><%else%><%=p+1%><%end%>
     <%end%>
     <%if @target_page<@max_pages-1%><%=link_to "Next&#8594;".html_safe,  imported_file_path(@imported_file,:page=>@target_page+1)%><%end%>
    </div>
  <%end%>
<%end%>
</div>
<div>
  <%=form_tag('',:id=>'frm_bulk') do %>
    <div id='div_bulk_content'></div>
  <%end%>
</div>
<div id='mod_preview' style='display:none;'>
  <div>
    <b>The first row of this file will perform the following actions.<br/>  
      Please double check that it looks right before clicking Go.<br />
      <span style='color:red;'>There is no undo for this action.</span></b>
  </div>
  <div id='preview_content'>
    Loading...
  </div>
</div>
<div id='mod_processing' style='display:none;'>
  File processing in the background.  This may take several minutes.  You will receive a message when processing is complete.
</div>
<div id='mod_loading' style='display:none;'>
  A preview of your file is loading.  Please wait.
</div>
<div id='mod_error' style='display:none;'>
  <p>There was an error reading the file you uploaded.  This might be related to corruption in the original file.</p>
  <p>Many times this can be fixed by opening the file in Excel and saving as a &quot;CSV&quot; file.</p>
  <p>If this does not work, please open a ticket by clicking the Help link at the top of the page.</p>
</div>
<div id='mod_download_items' style='display:none;'>
  <%=form_tag download_items_imported_file_path(@imported_file), :method=>:post, :id=>"frm_di" do %>
  <div>
    <input type='checkbox' id='filter_download' /> Filter
  </div>
  <table style='font-size:80%;' id='download_items_crits'></table>
  <hr />
  <div>
    <input type='radio' name='send_to' value='download' checked='checked' /> Download<br/>
    <input type='radio' name='send_to' value='email' id='di_email_radio'/> Email <span id='di_email_box' style='display:none;'><input type='text' name='email_to' width='30' id='di_email'/><span style='font-size:90%'>Separate addresses with a comma.</span></span>
  </div>
  <%end%>
</div>
