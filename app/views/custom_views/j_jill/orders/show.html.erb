<% content_for :action_bar do %>
  <button class='btn_link' link_to='<%=orders_path%>' key_map='b'>Back To Search</button>
  <% if @order.can_close?(current_user)%>
    <% if @order.closed? %>
      <%=button_to 'Reopen', reopen_order_path(@order), :method=>:post, :form_class=>"inline-button-to", :class=>'btn btn-secondary'%>
    <% else %>
      <%=button_to 'Close', close_order_path(@order), :method=>:post, :form_class=>"inline-button-to", :class=>'btn btn-secondary'%>
    <% end %>
  <% end %>
  <% if @order.can_accept?(current_user)%>
    <% if @order.approval_status=='Accepted' %>
      <%=button_to 'Unaccept', unaccept_order_path(@order), :method=>:post, :form_class=>"inline-button-to", :class=>'btn btn-secondary'%>
    <% elsif @order.can_be_accepted? %>
      <%=button_to 'Accept', accept_order_path(@order), :method=>:post, :form_class=>"inline-button-to", :class=>'btn btn-secondary'%>
    <% end %>
  <% end %>
  <button class='btn_link' link_to='<%=history_order_path(@order)%>' key_map='h'>History</button>
  <button onclick="window.print();">Print</button>
<% end %>
<%
# The where clause below is here to force a mysql query optimization that for some reason related to the first/limit used in the query
# gives the DB enough of a hint that allows it to use the order_line_id index, where if it's not here, then the index is not used and
# a full table scan is invoked when no piece sets exist for this order.

# Adding the where causes the query to jump in speed from around 30s to 1s.

# Adding most updated product record because we pull data directly from products below, so if a product is updated on the backend (like via a product upload)
# that info must show here too (this happened recently with F/W being updated and not causing this screen to reload)
most_recently_updated_product = Product.joins(:order_lines).where(order_lines: {order_id: @order.id}).order("products.updated_at DESC").first
cache [@order, @order.piece_sets.where("piece_sets.order_line_id is not null").order('piece_sets.updated_at DESC').first, most_recently_updated_product, 'jjillorder'] do%>
<%
require 'open_chain/custom_handler/vfitrack_custom_definition_support'
my_k = Class.new do
  include OpenChain::CustomHandler::VfitrackCustomDefinitionSupport
end
cdefs = my_k.prep_custom_definitions [:ord_line_color,:ord_line_size,:ord_entry_port_name,:prod_importer_style,:ord_ship_type,:prod_fish_wildlife]
%>
<style type="text/css">
  @media print {
    @page {size: landscape}
    body {
      font-size: 80%;
    }
    .header-table, .header-table td, .header-table tr {
      padding: 0;
      border: none !important;
    }
    #detail-table td {
      padding: 2px;
      border-bottom: 1px solid #ccc !important;
    }
  }
  .ord-header {
    width: 100%;
  }
  .ord-header td {
    vertical-align: top;
  }
</style>
<% content_for :javascript do %>
  $("window").ready(function() {
    $("[data-toggle='popover']").popover({html:true});
  });
<% end %>


<div class="container">
  <% if @order.closed? %>
    <div class="row">
      <div class="col-md-12">
        <div class="card alert-warning">
            <div class="card-header">Order Closed</div>
            <div class="card-body bg-white">
              Order closed <%=@order.closed_at%> <%if @order.closed_by%>by <%=@order.closed_by.full_name%><%end%>
            </div>
        </div>
      </div>
    </div>
  <% end %>
<div class="row print-only">
  <div class="col-md-12 text-right">
    <em>For purchase terms &amp; conditions, please refer to the J. Jill Vendor Manual.</em>
  </div>
</div>
  <div class="row">
    <div class="col-md-12">
      <h1 class='text-center'>J. Jill Purchase Order</h1>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <label>Ship To</label>
      <div>
        <%=  render :partial => 'addresses/display', :locals => { :ad => @order.ship_to, :name_override=>'Jill Acquisition LLC' } %>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <table class="header-table table-bordered table-condensed table-sm ord-header">
        <tr>
          <td>
            <label>PO #</label>
            <div><%=field_value @order, :ord_cust_ord_no%></div>
          </td>
          <td>
            <label>Issued By</label>
            <div><%=field_value @order, :ord_imp_name%></div>
          </td>
          <td>
            <label>Agent</label>
            <div><%=field_value @order, :ord_agent_name%></div>
          </td>
          <td>
            <label>Vendor</label>
            <div><%=field_value @order, :ord_ven_name%></div>
          </td>
          <td>
            <label>Vendor ID</label>
            <div><%=@order.vendor ? @order.vendor.system_code.gsub('JJILL-','') : nil%></div>
          </td>
        </tr>
      </table>
      <table class="header-table table-bordered table-condensed table-sm ord-header">
        <tr>
          <td>
            <label>Created</label>
            <div><%=field_value @order, :ord_ord_date%></div>
          </td>
          <td>
            <label>LGAC Date</label>
            <div><%=field_value @order, :ord_window_start%></div>
          </td>
          <td>
            <label>DC Due Date</label>
            <div><%=field_value @order, :ord_first_exp_del%></div>
          </td>
          <td>
            <label>Factory</label>
            <div><%=field_value @order, :ord_factory_name%></div>
          </td>
          <td>
            <label>Total PO First Cost</label>
            <div>$<%=@order.order_lines.inject(0) { |mem, var| mem+var.total_cost }%></div>
          </td>
          <td>
            <label>Mode</label>
            <div><%=field_value @order, :ord_mode%></div>
          </td>
        </tr>
      </table>
      <table class="header-table table-bordered table-condensed table-sm ord-header">
        <tr>
          <td>
            <label>Delivery Warehouse</label>
            <div><%=@order.ship_to ? @order.ship_to.system_code : nil%></div>
          </td>
          <td>
            <label>Terms</label>
            <div><%=field_value @order, :ord_terms%></div>
          </td>
          <td>
            <label>Origin Port</label>
            <div><%=field_value @order, :ord_fob_point%></div>
          </td>
          <td>
            <label>Origin Country</label>
            <div><%=field_value @order, :ord_fob_point%></div>
          </td>
          <td>
            <label>Ship Via</label>
            <div><%=field_value @order, cdefs[:ord_ship_type].model_field_uid.to_sym%></div>
          </td>
          <td>
            <label>Season</label>
            <div><%=field_value @order, :ord_season%></div>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <table id='detail-table' class="table table-condensed table-sm table-striped table-bordered">
        <thead>
          <th>Itm #</th>
          <th>Vend Style</th>
          <th>J Jill Item</th>
          <th>Color</th>
          <th>Size</th>
          <th>Fish &amp;<br/>Wildlife</th>
          <th>Qty</th>
          <th>UOM</th>
          <th>Unit Price</th>
          <th>Description</th>
          <th>HTS</th>
          <th class='no-print'>
            <button id='show-all-detail' class='btn btn-sm' onclick="$('.order-detail-line').show();$('#show-all-detail').hide();$('#hide-all-detail').show();">Show All</button>
            <button id='hide-all-detail' class='btn btn-sm' onclick="$('.order-detail-line').hide();$('#show-all-detail').show();$('#hide-all-detail').hide();" style='display:none;'>Hide All</button>
          </th>
        </thead>

        <tbody>
          <% @order.order_lines.each do |line| %>
            <tr class='hover ord_det_row'>
              <td><%=line.sku%></td>
              <td data-container='body' data-toggle="popover" data-trigger="hover" data-placement="auto" data-content="<%=ModelField.find_by_uid(:prod_name).label%>: <%=ModelField.find_by_uid(:prod_name).process_export(line.product,current_user)%>">
                <%display_uid = line.product.unique_identifier.sub('JJILL-','')%>
                <%-if line.product.can_view?(current_user)-%>
                  <%=link_to(display_uid, product_path(line.product)) %>
                <%-else-%>
                  <%=display_uid%>
                <%-end-%>
              </td>
              <td><%=line.product.get_custom_value(cdefs[:prod_importer_style]).value%></td>
              <td><%=line.get_custom_value(cdefs[:ord_line_color]).value%></td>
              <td><%=line.get_custom_value(cdefs[:ord_line_size]).value%></td>
              <td><%=line.product.get_custom_value(cdefs[:prod_fish_wildlife]).value.blank? ? 'NO' : 'YES'%></td>
              <td><%=line.quantity %></td>
              <td><%=line.product.unit_of_measure %></td>
              <td><%=line.price_per_unit %></td>
              <td><%=line.product ? line.product.name : nil%></td>
              <td><%=field_value line, :ordln_hts%></td>
              <td class='no-print'>
                <button class='btn btn-sm' onclick="$('#det_<%=line.id%>').toggle();">Detail</button>
              </td>
            </tr>
            <tr style='display:none;' class='order-detail-line' id='det_<%=line.id%>'>
              <td></td>
                <td colspan='8' >
                  <%=field_bootstrap 'Shipped', line.shipped_qty%>
                  <%=field_bootstrap 'Received', line.received_qty%>
                  <%Set.new(line.shipment_lines.collect{|sl| sl.shipment}).each do |s|%>
                    <div>Shipment: <%=link_to s.reference, s%></div>
                  <%end%>
                </td>
            </tr>
          <%end %>
          <tr>
            <td colspan='6'>
              <label>Total Lines:</label> <%=@order.order_lines.size%>
            </td>
            <td colspan='5'>
              <label>Total Quantity:</label> <%=@order.order_lines.inject(0) { |mem, var| mem+var.quantity }%>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
<%end%> <!--end cache-->
  <div class="row">
    <div class="col-md-6">
      <%# Template Dependency: shared/comments %>
      <%=render :partial => 'shared/comments', :locals => {:commentable => @order} %>
    </div>
    <div class="col-md-6">
      <%# Template Dependency: shared/attachments %>
      <%=render :partial => 'shared/attachments', :locals => {:attachable => @order} %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12 text-right">
      <em>For purchase terms &amp; conditions, please refer to the J. Jill Vendor Manual.</em>
    </div>
  </div>
</div>
<%=render :partial => 'shared/integration_file_link', :locals => {:obj => @order, :user => current_user} %>
