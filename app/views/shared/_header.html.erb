<!DOCTYPE html>
<html>
<%
  no_buttons = false
  no_buttons = true if @no_buttons
  no_buttons = true if !local_assigns[:not_buttons].nil?
  show_navbar = (!no_buttons && current_user)
  ms = MasterSetup.get
-%>
  <head>
    <title><%=@page_title.blank? ? 'VFI Track' : @page_title%></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%= favicon_links -%>
    <%= stylesheet_link_tag    "application", :media => "all" -%>
    <%= javascript_include_tag "application" -%>
    <% if @include_legacy_scripts %>
      <%= javascript_include_tag "legacy" %>
    <% end %>
    <%= csrf_meta_tags -%>
    <%= yield :head_tags -%>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <%= javascript_include_tag "html5shim" %>
    <![endif]-->
    <script type='text/javascript'>
      <% if current_user %>
        Chain.messagePoller.initialize('<%=current_user.id%>', 30);
        $(document).ready(function() {
          <% if @state_button_path && @state_button_object_id %>
            ChainStateButtons.initialize('<%=@state_button_path%>',<%=@state_button_object_id%>);
          <% end %>
        });
        <% if @include_legacy_scripts %>
          OpenChain.user_id = <%=current_user.id%>;
        <% end %>
      <% end %>
      <%= yield :javascript -%>
    </script>
  </head>
  <body>
      <% if @run_as_user %>
        <div id='run_as_box'>Logged In As: <%=@run_as_user.full_name%>, Running As: <%=current_user.full_name%> - <a href='/disable_run_as'>Disable</a></div>
      <% end %>
      <% if show_navbar -%>
        <div class="modal fade" id="notification-center">
          <div class="modal-dialog modal-max-width">
            <div class="modal-content">
              <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <div class="btn-group">
                  <button type="button" class="btn btn-default" notification-center-toggle-target='messages'>Messages</button>
                  <button type="button" class="btn btn-default" notification-center-toggle-target='tasks'>Tasks</button>
                </div>
              </div>
              <div class="modal-body" id='notification-center-body'>
                <div notification-center-pane='messages' content-url='/messages'></div>
                <div notification-center-pane='tasks' content-url='/my_tasks' data-load-trigger='chain:workflow-load'></div>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <chain-nav-panel-wrapper></chain-nav-panel-wrapper>
        <script type="text/javascript">
          $(function() {
            var userPromise = {
              then: function(callback) {
                callback(<%=current_user.api_hash.to_json.html_safe%>);
              }
            };
            writeNotificationCenter = function(wrapper) {
              wrapper.html("<a href='#' data-toggle='notification-center' onclick='return false;' title='shortcut key: n' class='message-envelope-wrapper'><span class='glyphicon glyphicon-bell message_envelope'></span></a>");
              Chain.messagePoller.initNotificationCenter();
            }
            ChainNavPanel.write(ChainNavPanelHtml,$('chain-nav-panel-wrapper'),userPromise,writeNotificationCenter);
          });
        </script>
      <% end -%>
      <div class='container'>
        <div class='row'>
          <%unless flash[:notices].blank?-%>
            <div class='col-md-12 alert alert-info alert-dismissable'>
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <%flash[:notices].each do |msg|-%>
                <p><%=msg%></p>
              <%end-%>
            </div>
          <%end-%>
          <%unless flash[:errors].blank?-%>
            <div class='col-md-12 alert alert-danger alert-dismissable'>
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <%flash[:errors].each do |msg|-%>
                <p><%=msg%></p>
              <%end-%>
            </div>
          <%end-%>
        </div>
      </div>

      <div id='main-content'>
        <%=yield%>
      </div>
    </div>




    <%unless @no_action_bar-%>
      <div class='navbar navbar-default navbar-fixed-bottom'>
        <ul class='nav navbar-nav'>
          <li id='nav-action-bar'>
            <div class='btn-group'>
              <%=yield :action_bar%>
            </div>
          </li>
        </ul>
        <% if @workflow_object %>
          <ul class='nav navbar-nav navbar-right'>
            <li>
              <a data-toggle="modal" href='#modal-workflow'>
                <span class='workflow-nav-icon glyphicon glyphicon-list-alt'></span>
              </a>
            </li>
          </ul>
        <% end %>
      </div>
    <%end-%>
    <% if @workflow_object%>
    <%# has to be outside of navbar %>
      <div class="modal fade" id="modal-workflow" data-wf-obj-id='<%=@workflow_object.id%>' data-wf-core-module='<%=CoreModule.find_by_object(@workflow_object).klass.name%>'>
        <div class="modal-dialog modal-max-width">
          <div class="modal-content">
            <div class="modal-body">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <div class="workflow-content"></div>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->
      <script type="text/javascript">
        $(document).ready(function() {
          ChainWorkflow.initWorkflow();
        });
      </script>
    <%end%>
    <%-if Rails.env.production?-%>
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');  
          ga('create', 'UA-43758898-1', 'vfitrack.net');
          ga('send', 'pageview');
      </script>
    <%-end-%>
    <%=yield :modal_container%>
  </body>
</html>
