<!DOCTYPE html>
<html>
<% 
  no_buttons = false
  no_buttons = true if @no_buttons
  no_buttons = true if !local_assigns[:not_buttons].nil?
  show_navbar = (!no_buttons && current_user)
  ms = MasterSetup.get
-%>
  <head>
    <title><%=@page_title.blank? ? 'VFI Track' : @page_title%></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%= favicon_link_tag -%>
    <%= stylesheet_link_tag    "application", :media => "all" -%>
    <%= javascript_include_tag "application" -%>
    <% if @include_legacy_scripts %>
      <%= javascript_include_tag "legacy" %>
    <% end %>
    <%= csrf_meta_tags -%>
    <%= yield :head_tags -%>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <%= javascript_include_tag "html5shim" %>
    <![endif]-->
    <script type='text/javascript'>
      <% if current_user %>
        Chain.messagePoller.initialize('<%=current_user.id%>', 30);
        $(document).ready(function() {Chain.messagePoller.initNotificationCenter();});
        <% if @include_legacy_scripts %>
          OpenChain.user_id = <%=current_user.id%>;
        <% end %>
      <% end %>
      <%= yield :javascript -%>
    </script>
  </head>
  <body>
    <% cache [ms, (current_user ? current_user.company : 0), (current_user ? current_user : 0), @run_as_user] do %>
      <% if @run_as_user %>
        <div id='run_as_box'>Logged In As: <%=@run_as_user.full_name%>, Running As: <%=current_user.full_name%> - <a href='/disable_run_as'>Disable</a></div>
      <% end %>
      <% if show_navbar -%>
        <div class='navbar' role='navigation' id='topnav'>
          <ul class="nav navbar-nav navbar-left pull-left" style='margin-left:3px;'>
            <li>
              <button id='btn-left-toggle' class='navbar-toggle' data-toggle="offcanvas">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right pull-right"  style='margin-right:3px;'>
            <li>
              <a href='#' data-toggle='notification-center' onclick="return false;" title='Notification Center' class='message-envelope-wrapper'>
                <span class='glyphicon glyphicon-bell message_envelope'></span>
              </a>
            </li>
          </ul>
          <form class='navbar-form hidden-xs' role='search' action='/quick_search' method='GET' id='quicksearch'>
            <div class='form-group'>
              <input type='text' class='search-query form-control' placeholder='enter search term' data-toggle='tooltip' title='press / to jump here' name='v' id='quick_search_input' /> 
              &nbsp;
              <a href='#' onclick="$('#quicksearch').submit(); return false;">
                <span class='glyphicon glyphicon-search'></span>
              </a>
            </div>
          </form>
        </div>

        <div class="sidebar-offcanvas panel-group" id="sidebar">
          <%=nav_item 'Home', '/'%>
          <%=nav_section 'prod-sec', 'Product', current_user.view_products? do%>
            <%=nav_item 'Search', '/products?force_search=true'%>
            <%=nav_item 'New', '/products/new', current_user.edit_products?%>
            <%=nav_item 'Search Tariffs', '/official_tariffs?force_search=true', current_user.view_official_tariffs?%>
            <%=nav_item 'Browse Tariffs', '/hts', current_user.view_official_tariffs?%>
          <%end%>
          <%=nav_section 'ord-sec', 'Order', current_user.view_orders? do%>
            <%=nav_item 'Search', '/orders?force_search=true', current_user.view_orders?%>
            <%=nav_item 'New', '/orders/new', current_user.edit_orders?%>
          <%end%>
          <%=nav_section 'shp-sec', 'Shipment', current_user.view_shipments? do%>
            <%=nav_item 'Search', '/shipments?force_search=true'', current_user.view_shipments?'%>
            <%=nav_item 'New', '/shipments/new', current_user.edit_shipments?%>
          <%end%>
          <%=nav_section 'so-sec', 'Sales Order', current_user.view_sales_orders? do%>
            <%=nav_item 'Search', '/sales_orders?force_search=true', current_user.view_sales_orders?%>
            <%=nav_item 'New', '/sales_orders/new', current_user.edit_sales_orders?%>
          <%end%>
          <%=nav_section 'del-sec', 'Delivery', current_user.view_deliveries? do%>
            <%=nav_item 'Search', '/deliveries?force_search=true', current_user.view_deliveries?%>
            <%=nav_item 'New', '/deliveries/new', current_user.edit_deliveries?%>
          <%end%>
          <%=nav_section 'isf-sec', 'Security Filing', current_user.view_security_filings? do%>
            <%=nav_item 'Search', '/security_filings?force_search=true', current_user.view_security_filings?%>
          <%end%>
          <%=nav_section 'ent-sec', 'Entry', current_user.view_entries? do%>
            <%=nav_item 'Browse - CA', '/entries/activity_summary/ca'%>
            <%=nav_item 'Browse - US', '/entries/activity_summary/us'%>
            <%=nav_item 'Search', '/entries?force_search=true'%>
            <%=nav_item 'Snapshot', '/entries/bi' %>
          <%end%>
          <%=nav_section 'binv-sec', 'Broker Invoice', current_user.view_broker_invoices? do%>
            <%=nav_item 'Search', '/broker_invoices?force_search=true'%>
          <%end%>
          <%=nav_section 'drw-sec', 'Drawback', current_user.view_drawback? do%>
            <%=nav_item 'Claims', '/drawback_claims'%>
            <%=nav_item 'Uploads', '/drawback_upload_files'%>
          <%end%>
          <%=nav_section 'srv-sec', 'Survey', (!current_user.survey_responses.blank? || current_user.view_surveys?) do%>
            <%=nav_item 'View', '/survey_responses'%>
            <%=nav_item 'Edit', '/surveys', current_user.view_surveys?%>
          <%end%>
          <%=nav_section 'more-sec', 'more...' do%>
            <%=nav_item 'Acccount', "/companies/#{current_user.company_id}/users/#{current_user.id}"%>
            <%=nav_item 'Dashboard', '/dashboard_widgets'%>
            <%=nav_item 'Reports', '/report_results'%>
            <%=nav_item 'Support', '/support_tickets'%>
            <%=nav_item 'Tools', '/tools'%>
            <%=nav_item 'Uploads', '/imported_files'%>
            <a href="#" data-toggle="modal" data-target="#homepage-modal" class='list-group-item'>Set Homepage</a>
            <%=nav_item 'Log Out', '/logout'%>
          <%end%>
          <div class="modal fade" id="homepage-modal">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header"><h4 class="modal-title">Set Homepage To Current Page</h4></div>
                <div class="modal-body">
                  <p>Click "OK" to make this page the first one you see when you log in to VFI Track.</p>
                  <p>You may also access your homepage at any time by clicking the Home link on the navigation bar.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" data-dismiss="modal" id="set-homepage-btn">OK</button>
                </div>
              </div>
            </div>
          </div>
        </div>          
      <% end -%>
      <%if !current_user.hide_message?('wh4') && current_user.created_at.to_i < DateTime.civil_from_format(:utc,2015,1,1).to_i%>
        <script type="text/javascript">
          $(document).ready(function() {
            $("#what-happened").modal();
            $("#never-show").click(function() {
              $("#what-happened").modal('hide');
              Chain.hideMessage('wh4');
            });
            $("#what-happened-close").click(function() {
              $("#what-happened").modal('hide');
            });
            $("#start-tour").click(function() {
              $("#what-happened").modal('hide');
              Chain.showNavTour();
            });
          });
        </script>
        <div id='what-happened' class='modal fade'>
          <div class='modal-dialog'>
            <div class='modal-content'>
              <div class='modal-header'>
                <h3>New Layout</h3>
              </div>
              <div class='modal-body'>
                <p>
                  We've updated the system layout.
                </p>
                <p>
                  All of your screens still work the same. <img src="/images/smile.png">
                </p>
              </div>
              <div class='modal-footer'>
                <button class='btn btn-link' id='what-happened-close'>Close</button>
                <button class='btn btn-link' id='never-show'>Never Show This Again</button>
                <button class='btn btn-primary' id='start-tour'>Start Tour</button>
              </div>
            </div>
          </div>
        </div>
      <%end%>
    <%-end-%>
      <div class='container'>
        <div class='row'>
          <%unless flash[:notices].blank?-%>
            <div class='col-md-12 alert alert-info alert-dismissable'>
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <%flash[:notices].each do |msg|-%>
                <p><%=msg%></p>
              <%end-%>
            </div>
          <%end-%>
          <%unless flash[:errors].blank?-%>
            <div class='col-md-12 alert alert-danger alert-dismissable'>
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <%flash[:errors].each do |msg|-%>
                <p><%=msg%></p>
              <%end-%>
            </div>
          <%end-%>
        </div>
      </div>  
  
      <div id='main-content' class='row-offcanvas row-offcanvas-left'>
        <form class='form-inline form visible-xs' role='search' action='/quick_search' method='GET' id='mini-qs'>
          <div class="container">
            <div class="row">
              <div class="col-xs-11">
                <input type='text' class='search-query form-control' placeholder='enter search term' data-toggle='tooltip' title='press / to jump here' name='v' /> 
              </div>
              <div class='col-xs-1'>
                <a href='#' onclick="$('#quicksearch').submit(); return false;">
                  <span class='glyphicon glyphicon-search'></span>
                </a>
              </div>
              </div>
            </div>
        </form>

        <%=yield%>
      </div>
    </div>


    <div id='notification-center' style='display:none;min-height:100%;height:100%;'>
      <div class="container" style='border:1px solid #aaa;background-color:white;margin-top:0;'>
        <div class="row">
          <div class="col-md-12">
            <button type="button" class="close" onclick="Chain.hideNotificationCenter();"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h3 class='text-center'>Notification Center</h3>
          </div>
        </div>
        <div id='notification-center-body'></div>
      </div>
    </div>

    <%unless @no_action_bar-%>
      <div class='navbar navbar-default navbar-fixed-bottom'>
        <ul class='nav'>
          <li id='nav-action-bar'>
            <div class='btn-group'>
              <%=yield :action_bar%>
            </div>
          </li>
        </ul>
      </div>
    <%end-%>
    <%-if Rails.env.production?-%>
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        <%-unless ms.request_host.blank?-%>
          <%-case ms.request_host -%>
          <%-when /chain\.io/-%>
            ga('create', 'UA-43758898-2', 'chain.io'); 
          <%-else-%>
            ga('create', 'UA-43758898-1', 'vfitrack.net');
          <%-end-%>
          ga('send', 'pageview');
        <%-end-%>
      </script>
    <%-end-%>
  </body>
</html>
