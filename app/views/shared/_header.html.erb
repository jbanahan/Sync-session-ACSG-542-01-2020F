<!DOCTYPE html>
<html>
<% 
  no_buttons = false
  no_buttons = true if @no_buttons
  no_buttons = true if !local_assigns[:not_buttons].nil?
  show_navbar = (!no_buttons && current_user)
  ms = MasterSetup.get
-%>
  <head>
    <title><%=@page_title.blank? ? 'VFI Track' : @page_title%></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%= favicon_link_tag -%>
    <%= stylesheet_link_tag    "application", :media => "all" -%>
    <%= javascript_include_tag "application" -%>
    <% if @include_legacy_scripts %>
      <%= javascript_include_tag "legacy" %>
    <% end %>
    <%= csrf_meta_tags -%>
    <%= yield :head_tags -%>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <%= javascript_include_tag "html5shim" %>
    <![endif]-->
    <script type='text/javascript'>
      Chain.setAuthToken('<%=form_authenticity_token%>');
      <% if current_user %>
        Chain.messagePoller.initialize('<%=current_user.id%>', 30)
        <% if @include_legacy_scripts %>
          OpenChain.user_id = <%=current_user.id%>;
        <% end %>
      <% end %>
      <%= yield :javascript -%>
    </script>
  </head>
  <body>
    <% cache ['v8',ms,(current_user ? current_user.company : 0),(current_user ? current_user : 0),@run_as_user] do %>
      <% if @run_as_user %>
        <div id='run_as_box'>Logged In As: <%=@run_as_user.full_name%>, Running As: <%=@current_user.full_name%> - <a href='/disable_run_as'>Disable</a></div>
      <% end %>
      <% if show_navbar -%>
        <div class='navbar navbar-default' role='navigation' id='topnav'>
          <div class="navbar-header">
            <button type="button" class='navbar-toggle' data-toggle="collapse" data-target="#top-nav-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand dash-container" href="/">
              <%=image_tag(master_setup.logo_image.blank? ? "vfi_logo.png" : master_setup.logo_image, :class=>'dash-logo')%>
            </a>
          </div>
          <div class='collapse navbar-collapse' id="top-nav-collapse">
            <ul class="nav navbar-nav">
              <% if current_user.view_products? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' data-toggle='dropdown' href='#'>
                    Products
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li><a href='/products?force_search=true'>Search</a></li>
                    <% if current_user.edit_products?-%>
                      <li><a href='/products/new'>New</a></li>
                    <% end -%>
                    <% if current_user.view_official_tariffs?-%>
                      <li><a href='/official_tariffs?force_search=true'>Tariffs</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_orders? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Orders
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/orders?force_search=true'>Search</a></li>
                    <% if current_user.edit_orders? -%>
                      <li ><a href='/orders/new'>New</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_shipments? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Shipments
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/shipments?force_search=true'>Search</a></li>
                    <% if current_user.edit_shipments? -%>
                      <li ><a href='/shipments/new'>New</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_sales_orders? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Sales 
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/sales_orders?force_search=true'>Search</a></li>
                    <% if current_user.edit_sales_orders? -%>
                      <li ><a href='/sales_orders/new'>New</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_deliveries? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Deliveries 
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/deliveries?force_search=true'>Search</a></li>
                    <% if current_user.edit_deliveries? -%>
                      <li ><a href='/deliveries/new'>New</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_security_filings? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Security Filings 
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/security_filings?force_search=true'>Search</a></li>
                    <% if current_user.edit_security_filings? -%>
                      <li ><a href='/security_filings/new'>New</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_entries? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Entries 
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li><a href='/entries/activity_summary/us'>Browse - US</a></li>
                    <li><a href='/entries/activity_summary/ca'>Browse - Canada</a></li>
                    <li ><a href='/entries'>Search</a></li>
                    <li ><a href='/entries/bi'>Snapshots</a></li>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_broker_invoices? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Broker Invoices
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/broker_invoices'>Search</a></li>
                  </ul>
                </li>
              <% end -%>
              <% if current_user.view_drawback? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Drawback
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/drawback_claims'>Claims</a></li>
                    <li ><a href='/drawback_upload_files'>Upload</a></li>
                  </ul>
                </li>
              <% end -%>
              <% if !current_user.survey_responses.blank? || current_user.view_surveys? -%>
                <li class='dropdown'>
                  <a class='dropdown-toggle' role='button' data-toggle='dropdown' href='#'>
                    Surveys 
                    <b class='caret'></b>
                  </a>
                  <ul class='dropdown-menu' role='menu'>
                    <li ><a href='/survey_responses'>View</a></li>
                    <% if current_user.view_surveys? -%>
                      <li ><a href='/surveys'>Edit</a></li>
                    <% end -%>
                  </ul>
                </li>
              <% end -%>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class='dropdown' id='menu_dropdown'>
                <a class='dropdown-toggle' data-toggle='dropdown' href='#'>
                  <%=current_user.full_name%>
                  <b class='caret'></b>
                </a>
                <ul class='dropdown-menu' role='menu'>
                  <li><a href='/companies/<%=current_user.company_id%>/users/<%=current_user.id%>'>Account</a></li>
                  <li><a href="/dashboard_widgets">Dashboard</a></li>
                  <li><a href='/messages'>Messages</a></li>
                  <li><a href='/report_results'>Reports</a></li>
                  <li><a href='/support_tickets'>Support</a></li>
                  <li><a href='/tools'>Tools</a></li>
                  <li><a href='/imported_files'>Uploads</a></li>
                  <li><a href="#" data-toggle="modal" data-target="#homepage-modal">Set Homepage</a></li>
                  <li><a href='/logout'>Log Out</a></li>
                </ul>
              </li>
            </ul>
            <form class='navbar-form navbar-right' role='search' action='/quick_search' method='GET'>
              <div class='form-group'>
                <input type='text' class='search-query form-control' placeholder='enter search term' data-toggle='tooltip' title='press / to jump here' name='v' id='quick_search_input' /> 
              </div>
            </form>
            <ul class="nav navbar-nav navbar-right">
              <li>
                <a href='/messages/'><span class='label label-primary' id='message_envelope'></span></a>
              </li>
            </ul>
          </div>
        </div>
        <div class="modal fade" id="homepage-modal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header"><h4 class="modal-title">Set Homepage To Current Page</h4></div>
              <div class="modal-body">
                <p>Click "OK" to make this page the first one you see when you log in to VFI Track.</p>
                <p>You may also access your homepage at any time by clicking the <%=image_tag(master_setup.logo_image.blank? ? "vfi_logo.png" : master_setup.logo_image, :class=>'dash-logo')%> in the upper left corner of the page.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="set-homepage-btn">OK</button>
              </div>
            </div>
          </div>
        </div>
      <% end -%>
    <% end -%>
    <div class='container'>
      <div class='row'>
        <%unless flash[:notices].blank?-%>
          <div class='col-md-12 alert alert-info alert-dismissable'>
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <%flash[:notices].each do |msg|-%>
              <p><%=msg%></p>
            <%end-%>
          </div>
        <%end-%>
        <%unless flash[:errors].blank?-%>
          <div class='col-md-12 alert alert-danger alert-dismissable'>
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <%flash[:errors].each do |msg|-%>
              <p><%=msg%></p>
            <%end-%>
          </div>
        <%end-%>
      </div>
    </div>

    <div id='main-content'>
      <%=yield%>
    </div>

    <%unless @no_action_bar-%>
      <div class='navbar navbar-default navbar-fixed-bottom'>
        <ul class='nav'>
          <li id='nav-action-bar'>
            <%=yield :action_bar%>
          </li>
        </ul>
      </div>
    <%end-%>
    <%-if Rails.env.production?-%>
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        <%-unless ms.request_host.blank?-%>
          <%-case ms.request_host -%>
          <%-when /chain\.io/-%>
            ga('create', 'UA-43758898-2', 'chain.io'); 
          <%-else-%>
            ga('create', 'UA-43758898-1', 'vfitrack.net');
          <%-end-%>
          ga('send', 'pageview');
        <%-end-%>
      </script>
    <%-end-%>
  </body>
</html>
