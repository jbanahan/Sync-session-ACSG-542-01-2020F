<%=
require 'csv'
opts = {:write_headers=>true,:row_sep => "\r\n"}
headers = []
@current_search.search_columns.order("rank ASC").each do |c|
    headers << model_field_label(c.model_field_uid)
end
opts[:headers] = headers 
x = CSV.generate(opts) do |csv|
  @results.each do |r|
    to_append = []
    @current_search.search_columns.order("rank ASC").each do |c|
      mf = ModelField.find_by_uid(c.model_field_uid)
      if mf.uid==:_blank || mf.core_module==@core_module
        to_append << mf.process_export(r)
      else
        joined = ""
        @core_module.children(mf.core_module,r).each do |child|
          joined << "#{mf.process_export child};"
        end
        to_append << joined
      end
    end
    csv << to_append
  end
end
raw x %>
