<% sq = SearchQuery.new(@current_search,current_user)-%>
<%content_for :javascript do%>
$(function() {
  <% #the blank check below is because the unique parent count doesn't matter if we're not putting the bulk action checkboxes in so it's not worth making the EXPENSIVE db call -%>
  OCSearch.init(<%=@bulk_actions.blank? || @bulk_actions.empty? ? 0 : sq.unique_parent_count%>,<%=@current_search.search_run.id%>,"<%=url_for @current_search%>","search_setup");
  <% unless @bulk_actions.blank? %>
    <% @bulk_actions.each do |k,v| %>
      <% if v.is_a? String -%>
        OCSearch.addBulkHandler('<%="btn_bulk_#{k.gsub(/ /,"").underscore}"%>','<%=v.match(/^\//) ? v : send(v)%>');
      <% else -%>
        <% p = v[:path] -%>
        OCSearch.addBulkHandler('<%="btn_bulk_#{k.gsub(/ /,"").underscore}"%>','<%=p.match(/^\//) ? p : send(p)%>',eval(<%=v[:callback]%>));
      <% end -%>
    <% end %>
  <% end %>
  <%if current_user.search_open? %>
    OCSearch.showSetup();
  <%end%>
  $("#lnk_no_upload").click(function(ev) {
    ev.preventDefault();
    $("#mod_no_upload").dialog('open');
  });
  $("#mod_no_upload").dialog({autoOpen:false,title:"Upload Eligibility",
    width:400,
    buttons:{"OK":function() {$("#mod_no_upload").dialog('close');}}});
  $("#btn_download").click(function() {window.location.pathname = window.location.pathname + '<%=@current_search.download_format.blank? ? ".csv" : ".#{@current_search.download_format}"%>'})
  $("#btn_upload").click(function() {window.location = '<%=new_search_setup_imported_file_path @current_search%>';});
  $("#sel_searches").change(function() {
    var myId = $(this).val();
    $("#main_search_cont").html("<h1>Loading Search Results</h1>");
    window.location.search="?sid="+myId;
  });
  
  $("#show_srch_setup").click(function(ev) {
    ev.preventDefault();
    OCSearch.showSetup();
  });
  $("#hide_srch_setup").click(function(ev) {
    ev.preventDefault();
    OCSearch.hideSetup();
  });

  processHiddenColumns(false);
  $('table#result_table thead tr th').click(function() {
    if ($(this).children(0).is("input") || $(this).text() == "Actions") {
      return false;
    }

    var col = $(this).prevAll().length + 1;
    hideColumn(col);
  });
  $('#show_all_columns').click(function() {
    processHiddenColumns(true);
  });
});
<%end%>
<div id='main_search_cont'>
  <div id='search_select_box'>
    <%=select_tag "sel_searches",  options_from_collection_for_select(@saved_searches, 'id', 'name', @current_search.id)%>
    &nbsp;<a href='#' id='show_srch_setup'>Show Setup</a><a href='#' id='hide_srch_setup' style='display:none;'>Hide Setup</a>
  </div>
  <%=render :partial=>'shared/search_panel', :locals=>{:show=>false,:include_sorts=>true,:current_search=>@current_search,:parent_hash_name=>'search_setup'}%>
  <div id='bulk_message'></div>
  <div id='show_all_columns'><p>Click Headings To Hide Columns</p></div>
  <table class='detail_table' id='result_table'>
    <thead><tr>
      <% unless @bulk_actions.blank?%><th><input type='checkbox' id='chk_sel_all' /></th><%end%>
      <th>Actions</th>
      <%@current_search.search_columns.order("rank ASC").each do |c|%>
      <th><%=model_field_label(c.model_field_uid)%></th>
      <% end %>
    </tr></thead>
    <tbody id='result_rows'>
    </tbody>
  </table>
</div>
<div id='pagination'>

</div>
<div> 
<%=form_tag('',:id=>'frm_bulk') do %>
  <div id='div_bulk_content'></div>
  <div id='div_bulk_carry_over'></div>
<% end %>
</div>
<%content_for :action_bar do %>
  <%unless @bulk_actions.blank?%>
    <%@bulk_actions.keys.each do |k|%>
      <button id='<%="btn_bulk_#{k.gsub(/ /,"").underscore}"%>'><%=k%></button>
    <%end%>
  <%end%>
  <button id='btn_download'>Download</button>
  <%msgs = [] %>
  <% if @current_search.uploadable? msgs %>
  <button id='btn_upload'>Upload</button>
  <% else %>
  <a href='#' id='lnk_no_upload'>Upload?</a>
  <div style='display:none;' id='mod_no_upload'>
    <p>Some searches cannot be used as upload because the computer will not have enough information to process the data.</p>
    <p>Here's why this upload can't be used:</p>
    <ul>
    <%msgs.each do |m| %>
    <li><%=m%>
    <%end%>
    </ul>
  </div>
  <% end %>
  <%if @current_search.core_module.klass.new.respond_to?(:attachments) -%>
    <button class='btn_link' link_to='<%=attachments_search_setup_path(@current_search)%>'>Attachment List</button>
  <%end-%>
<% end %>
<script>
  OCAdvancedSearch.loadInitialRows("#result_rows",<%=@current_search.id%>);
  <%=sq_count = sq.count%>
  OCAdvancedSearch.loadPagination("#pagination",<%=@current_search.id%>);
</script>
