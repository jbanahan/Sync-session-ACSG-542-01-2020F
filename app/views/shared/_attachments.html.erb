<% if !local_assigns.has_key?(:view_only) || !view_only%>
  <% content_for :javascript do %>
    $(document).ready(function() {
      $('.attachment_icon').popover({html: true});
    });    
  <% end %>
  <% can_attach = !attachable.respond_to?('can_attach?') || attachable.can_attach?(current_user) %>
  <% if can_attach%>
    <% content_for :action_bar do %>
      <button title='Add Attachment' class="btn btn-secondary" data-toggle="modal" href='#mod_attach_bs'><i class='fa fa-paperclip'></i></button>
    <%end%>
  <% end %>
<%end-%>
<% attachments = (attachable.respond_to?('all_attachments') ? attachable.all_attachments : attachable.attachments).find_all {|a| a.can_view?(current_user) }-%>
  <div id="<%="#{attachable.class.name.underscore}_attachments"%>" class='row text-center'>
    <div class='col-md-12'>
      <h3>Attachments</h3>
    </div>
  </div>
  <% if attachments.blank? %>
    <div class="well">
      There aren't any attachments.
      <% if can_attach %>
        Create one with the <i class='fa fa-paperclip'></i> button below.
      <% end %>
    </div>
  <% else %>
      <% attachments.each_with_index do |att, attachment_counter| %>
        <% if attachment_counter%3 == 0 %>
          <div class="row">
        <% end %>
          <div class='col-sm-6 col-md-4'>
            <div class='thumbnail text-center'>
              <div class='attachment_delete' class='text-right'>
                <%if attachable.can_edit?(current_user) && !att.attachable.is_a?(LinkableAttachment)%>
                  <%del_path = local_assigns.has_key?(:redirect_to) ? attachment_path(:id=>att.id,:redirect_to=>redirect_to) : att%>
                  <div class="float-right">  
                    <%=link_to(image_tag("x.png",:size=>"16x16"), del_path, :method => :delete, :confirm => "Are you sure you want to delete this?")%>
                    <% if att.is_private? %>
                      <i class="fa fa-eye-slash" title="private"></i>
                    <% end %>
                  </div>
                <%else%>
                  <%=image_tag('spacer.gif',:size=>'16x16')%>
                <%end%>
              </div>
              <%=attachment_icon att%>
              <div class='caption' style="word-wrap:break-word">
                <%unless att.attachment_type.blank?%><h4><%=att.attachment_type%></h4><%end%>
                <p>
                  <%=att.attached_file_name%>
                </p>
                <p>
                  <%=link_to 'Download', download_attachment_path(att), :class=>'btn btn-primary btn-sm', :role=>'button', :target=>"chainio_attachment"%>
                </p>
              </div>
            </div>
          </div>
          <% if ((attachment_counter+ 1) % 3) == 0 || attachment_counter==(attachments.size - 1)%>
            </div>
          <% end %>
      <% end -%>
  <div class="row">
    <div class="col-md-12 text-center">
      <a href="/attachments/email_attachable/<%= attachable.class %>/<%= attachable.id %>">
        <button class="btn btn-secondary" id="email_attachments_button">Email attachments</button>
      </a>
    </div>
  </div>
<%end-%>

<%content_for :modal_container do %>
<div class="modal fade" id="mod_attach_bs">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Attach File</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      </div>
      <div class="modal-body">  
        <% att = attachable.attachments.build %>
        <%= form_for att, html: {multipart: true, id: "frm_attach", role: "form"} do |f| %>
          <% if local_assigns.has_key?(:redirect_to) %>
            <input type='hidden' name='redirect_to' value="<%=redirect_to%>" />
          <% end %>
          <%= f.hidden_field :attachable_id %>
          <%= f.hidden_field :attachable_type %>
          <div class="form-group">
            <%= f.label :attachment_type, "Attachment Type" %>
            <%= f.collection_select :attachment_type, AttachmentType.all, :name, :name, {}, {class: "form-control"} %>
          </div>
          <div class="form-group">
            <input type="file" id="attachment_attached" name="attachment[attached]" style="width: 100%">
          </div>
          <%if current_user.company.master? %>
            <%att.is_private = true%>
            <div class="checkbox">
              <label>
                <%= f.check_box :is_private %> Private Attachment?
              </label>
            </div>
          <%end%>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="$('#frm_attach').submit();">Attach</button>
      </div>
    </div>
  </div>
</div>
<%end%>
