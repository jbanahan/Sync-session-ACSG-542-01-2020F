<%content_for :javascript do%>
  $(function() {
    OCSearch.initSearchCriterions();
    $(document).on('click', ".sp_remove", function(ev){
      ev.preventDefault();
      destroy_nested('sp',$(this));
    });
    $(document).on('click', "#sp_add", function(ev) {
      ev.preventDefault();
      addNewSearchCriterion();
    });
    $('#<%=wrapper%>').html("<table id='sp_table'></table><a href='#' id='sp_add' class='btn btn-primary' role='button'>Add</a>");
    <% sc_counter = 0 %>
    <% current_search.search_criterions.each do |sc| %>
      <% 
        # Strips timezone from datetime criterions
        sc_value = sc.value
        # See search_criterion for regex explanation
        if ModelField.find_by_uid(sc.model_field_uid).data_type == :datetime && sc_value =~ /\A([\d\-\/]+)( +([\d:]+)? *(.*)?)?\z/
          sc_value = $1 + ($3.nil? ? "" : " " + $3)
        end
      %>
      addSearchCriterion(<%=sc_counter%>,'<%=sc.model_field_uid%>','<%=sc.operator%>','<%=escape_javascript sc_value%>','<%=sc.id%>', <%=sc.include_empty == true%>);
      <% sc_counter += 1 %>
    <% end %>
  });
  function addSearchCriterion(m,field,operator,value,id, include_empty_checked) {
    var fields = [];
    <%ModelField.sort_by_label(model_fields, true).each do |mf| %>
      <% next unless mf.can_view?(current_user)%>
      fields.push({"uid":'<%=escape_javascript mf.uid.to_s%>',"dtype":'<%=escape_javascript mf.data_type.to_s%>',"label":'<%=escape_javascript (mf.can_view?(User.current) ? mf.label(true) : ModelField.disabled_label)%>'});
    <%end%>
    OCSearch.addSearchCriterion($("#sp_table"),'<%=parent_hash_name%>',fields,m,field,operator,value,id,true, include_empty_checked);
  }
  function addNewSearchCriterion() {
    addSearchCriterion(new Date().getTime(),null,null,null);
  }
<%end%>
