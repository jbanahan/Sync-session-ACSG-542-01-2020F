<%-content_for :action_bar do-%>
  <%if current_user.edit_projects?%>
    <button class='btn btn-default' id='btn-new'>New</button>
  <%end%>
  <button class='btn btn-default btn_link' link_to='<%=project_deliverables_path%>'>Deliverables</button>
  <button class='btn btn-default' id='toggle-closed-projects'>Show Closed Projects</button>
<%-end-%>
<%-cache ['project_index',Project.select('projects.id, projects.updated_at').order('updated_at DESC').first] do-%>
<%@projects = @projects.order('closed_at ASC, on_hold ASC, name ASC, due ASC')%>
<h1 class="text-center">Projects</h1>
<table id="project-table" class="table table-striped table-collapse table-hover tablesorter">
  <thead>
    <tr>
      <th>&nbsp;</th>
      <th style="cursor:pointer" id="name-header">Name</th>
      <th style="cursor:pointer" id="due-header">Due</th>
      <th style="cursor:pointer" id="deliverables-header">Incomplete Deliverables</th>
      <th style="cursor:pointer" id="sets-header">Sets</th>
      <th style="display:none" id="closed-header">Closed?</th>
      <th style="display:none" id="hold-header">On Hold?</th>
    </tr>
  </thead>
  <tbody>
    <%-@projects.each do |p|-%>
      <%-cache ['project_index_row', p, 0.seconds.ago.strftime('%Y-%m-%d')] do #cache at this level because the .red? method is expensive-%>
        <tr class='<%=p.red? ? 'danger' : 'no-danger'%> <%=p.closed_at ? 'closed-project' : ''%>' style='<%= p.closed_at.nil? ? '' : 'display:none' %>' data-project-id='<%=p.id%>'>
          <td><%=link_to 'View', p, :class=>'btn btn-xs btn-default'%></td>
          <td><%=p.name%>
            <%=p.closed_at ? ' <span class="label label-default">closed</span> '.html_safe : ''%>
            <%=p.on_hold? ? '<span class="label label-warning">on hold</span> '.html_safe : '' %>
          </td>
          <td><%=p.due%></td>
          <td><%=p.project_deliverables.incomplete.count%></td>
          <td>
            <%-p.project_sets.each do |ps|-%>
              <a href=<%=project_set_path(ps)%> style="text-decoration:none;">
                <span class='label label-default'><%=ps.name%></span>
              </a>
            <%-end-%>
          </td>
          <td style="display:none">
            <%=p.closed_at.nil? ? 'No' : 'Yes' %>
          </td>
          <td style="display:none">
            <%=p.on_hold? ? 'Yes' : 'No' %>
          </td>
        </tr>
      <%-end-%>
    <%-end-%>
  </tbody>
</table>
<div class='modal fade' id='mod-new'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <%=form_for Project.new, :id=>'frm_new' do |f|%>
          <label for='pName'>New Project Name</label>
          <%=f.text_field :name, :class=>'form-control', :id=>'new_name'%>
          <%=f.submit "Create", :class=>'btn btn-primary'%>
          <button class='btn btn-default' data-dismiss='modal'>Cancel</button>
        <%end%>
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function() {
    $('#mod-new').on('shown.bs.modal',function() {
      $('#new_name').focus(); 
    })
    $('#btn-new').click(function() {
      $('#mod-new').modal('show');
    });
  });
</script>
<%-end #end cache-%>

<%- content_for :javascript do %>

  $(function() {
    var showClosed = -1;

    $("#toggle-closed-projects").click(function(){
      showClosed *= -1;
      if (showClosed == 1){
        $(".closed-project").css("display","table-row");
        $("#toggle-closed-projects").text("Hide Closed Projects");
      }
      else{
        $(".closed-project").css("display","none");
        $("#toggle-closed-projects").text("Show Closed Projects");
      }
    });

    if (typeof(Storage) !== void(0))
    {
      if (typeof(Chain.getStorageItem("user-projects-sort"))==="undefined" || Chain.getStorageItem("user-projects-sort")==null){
        Chain.setStorageItem("user-projects-sort",{order: [[5,0],[6,0],[2,0]]});
      }

      startingOrder = [];
      $.each(Chain.getStorageItem("user-projects-sort").order, function(index, value){ startingOrder.push(value)});

      $("#project-table").tablesorter({
        sortList: startingOrder,
        sortForce: [[5,0],[6,0]]
      }).bind("sortEnd", function(sorter){
        Chain.setStorageItem("user-projects-sort",{order: sorter.target.config.sortList});
        setProjectOrder();
      });

      setProjectOrder();

    }
    else
    {
      $("#project-table").tablesorter({
        sortList: [[5,0],[6,0],[2,0]],
        sortForce: [[5,0],[6,0]]
      });
    }

    function setProjectOrder() {
      order = [];
      $.each($("tr"), function(index, value){
        if ($(value).data("project-id")!=null){ 
          order.push($(value).data("project-id"));
        }
      });
      Chain.setStorageItem("user-projects-sorted-ids", {ordered_ids: order})
    }

  });
<% end %>
