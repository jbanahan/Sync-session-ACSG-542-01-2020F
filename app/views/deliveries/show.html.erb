<% content_for :javascript do %>
  $(function() {
    $( "#btn_edit" )
      .click(function() {
        window.location = '<%=edit_delivery_path(@delivery)%>';
      });
    $("#mod_subscriptions").dialog({autoOpen:false,title:"Subscriptions",
      buttons:{"Subscribe":function() {$("#frm_sub").submit();}}});
    $("#btn_subscriptions")
      .click(function() {
        $("#mod_subscriptions").dialog('open');
    });
    OpenChain.addClickMap('e','Edit','btn_edit');
    OpenChain.activateHotKeys();
  });
<% end %>

<% content_for :action_bar do %>
  <% if @delivery.can_edit?(current_user) %>
  <button id='btn_edit'>Edit</button>
  <%end%> 
  <button class='btn_link' link_to='<%=deliveries_path%>' key_map='b'>Back To Search</button>
  <button class='btn_link' link_to='<%=history_delivery_path(@delivery)%>' key_map='h'>History</button>
<% end %>

<div class="container">
  <div class="row">
    <div class="col-md-6">
      <%= show_model_fields @delivery, :del_ref %>
      <%= show_model_fields @delivery, :del_cust_name %>
    </div>
  </div>
</div>
<table class='detail_table'>
  <thead>
    <%= model_field_labels([:del_ship_from_name, :del_ship_to_name], table: true, heading: true) %>
  </thead>
  <tbody><tr>
    <td style='width:50%' class='hover'>
      <% if ModelField.find_by_uid(:del_ship_from_name).can_view?(User.current) %>
        <%=  render :partial => 'addresses/display', :locals => { :ad => @delivery.ship_from, :address_id => 'ship_from_ad' } %>
      <% end %>
    </td>
    <td style='width:50%' class='hover'>
      <% if ModelField.find_by_uid(:del_ship_to_name).can_view?(User.current) %>
        <%=  render :partial => 'addresses/display', :locals => { :ad => @delivery.ship_to, :address_id => 'ship_to_ad' } %>
      <% end %>
    </td>
  </tr></tbody>
</table>
<br />
<div style="width:95%;margin-bottom:10px">
<%=render :partial => 'shared/attachments', :locals => {:attachable => @delivery} %>
<div class='next_to_attachments'>
<table>
  <tbody>
      <%= show_model_fields @delivery, [:del_car_name, :del_mode], table: true %>
	    <%=show_custom_fields @delivery, {:table=>true}%>
  </tbody>
</table>
</div>
</div>

<table class='detail_table'>
  <thead>
    <th>&nbsp;</th>
    <%= model_field_labels([:delln_line_number, :prod_name, :delln_delivery_qty, :soln_line_number], table: true, heading: true) %>
    <th><a href='#' id='lnk_all_details'>All Details</a></th>
  </thead>
  <tbody>
    <%@delivery.delivery_lines.order("line_number ASC").each do |line|%>
    <tr class='hover shp_line'>
      <td>
        <%if @delivery.can_edit?(current_user) && !@delivery.locked?%>
          <button class='btn_link btn btn-sm' link_to='<%=edit_delivery_delivery_line_path(@delivery,line)%>'>edit</button>
        <%end%>
      </td>
      <%= show_model_fields line, :delln_line_number, table: true, editor_only: true %>
      <% if ModelField.find_by_uid(:prod_name).can_view?(current_user) && line.product.try(:can_view?, current_user) %>
        <td><%= link_to ModelField.find_by_uid(:prod_name).process_export(line.product, User.current), product_path(line.product) %></td>
      <% end %>
      <%= show_model_fields line, :delln_delivery_qty, table: true, editor_only: true %>
      <td>
        <% mf =  ModelField.find_by_uid(:ord_ord_num)
           view_order = mf.can_view? User.current
        %>
        <%line.sales_order_lines.each do |so|
          order_line = mf.process_export(so.sales_order, User.current).to_s
          order_line += " - " + ModelField.find_by_uid(:soln_line_number).process_export(so, User.current).to_s
        %>
          <% if view_order %>
            <%=link_to order_line, so.sales_order%>
          <% else %>
            <%= order_line %>
          <% end %>
          <br>
        <%end%>
      </td>
      <td>
        <%if has_custom_fields(line)%><a href='#' class='lnk_detail'>Details</a><%end%>
        <%if has_custom_fields(line) && @delivery.can_edit?(current_user)%>
        &nbsp;|&nbsp;
        <%end%>
        <%if @delivery.can_edit?(current_user)%>
          <%=link_to "Delete", delivery_delivery_line_path(@delivery,line), :data => {:confirm=>'Are you sure you want to delete this line?'}, :method=>:delete %>
        <%end%>
      </td>
    </tr>
    <tr class='shp_line_detail' style='display:none;'>
      <td colspan='5' style='padding-left:1em'>
      <%=show_custom_fields line%>
      </td>
    </tr>
    <%end%>
  </tbody>
</table>
<%=render :partial => 'shared/pack_lines', :locals => {:parent=>@delivery, :line=>@line, :products=>@products, :is_sales_order=>true} %>
<%=render :partial => 'shared/comments', :locals => {:commentable => @delivery} %>
