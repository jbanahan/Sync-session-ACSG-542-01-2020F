<%-content_for :javascript do -%>
$(function() {
  <%- cmsg = @cap.can_edit?(current_user) ? 'caped' : 'capvw'-%>
  <%-if @cap.can_edit?(current_user) && !current_user.hide_message?('caped')-%>
  $('document').ready(function() { $('#tour-prompt').modal(); });
  $('#show-tour').click(function() {
    $('#tour-prompt').modal('hide');
    bootstro.start('',{items:[
      {selector:'#plan-title',placement:'bottom',content:"The corrective action plan is where you'll instruct the survey recipient on things they need to do to improve on the answers they gave in the survey."},
      {selector:'#status-display',placement:'right',content:"The plan has 3 statuses:<br /><ul><li><strong>New</strong>: <%=CorrectiveActionPlan::STATUS_DEFINITIONS[:new]%></li><li><strong>Active</strong>: <%=CorrectiveActionPlan::STATUS_DEFINITIONS[:active]%></li><li><strong>Resolved</strong>: <%=CorrectiveActionPlan::STATUS_DEFINITIONS[:resolved]%></li></ul>"},
      {selector:'#comments-title',placement:'top',content:"Everyone can add comments here."},
      {selector:'legend.issue-legend:first',placement:'top',content:"You add a <em>Description</em> and <em>Suggested Action</em> for each issue. The recipient adds an <em>Action Taken</em>."},
      {selector:'#add-issue',placement:'top',content:"Click here to add more issues."},
      <%-if @cap.status!=@cap.class::STATUSES[:active]-%>
      {selector:'#btn-activate',placement:'top',content:"Click here to activate the plan so the recipient can see it."},
      <%-end-%>
      {selector:'#btn-save',placement:'top',content:"Don't forget to save your changes."}
    ]});
  });
  <%-elsif !current_user.hide_message?('capvw')-%>
  $('document').ready(function() { $('#tour-prompt').modal(); });
  $('#show-tour').click(function() {
    $('#tour-prompt').modal('hide');
    bootstro.start('',{items:[
      {selector:'#plan-title',placement:'bottom',content:"The corrective action plan is where you'll provide feedback on changes that need to be made based on your survey response."},
      {selector:'#status-display',placement:'right',content:"The plan has 2 statuses:<br /><ul><li><strong>Active</strong>: <%=CorrectiveActionPlan::STATUS_DEFINITIONS[:active]%></li><li><strong>Resolved</strong>: <%=CorrectiveActionPlan::STATUS_DEFINITIONS[:resolved]%></li></ul>"},
      {selector:'#comments-title',placement:'top',content:"Everyone can add comments here."},
      {selector:'legend.issue-legend:first',placement:'top',content:"The survey manager adds a <em>Description</em> and <em>Suggested Action</em> for each issue. You add the <em>Action Taken</em>."},
      {selector:'#btn-save',placement:'top',content:"Don't forget to save your changes."}
    ]});
  });
  <%-end-%>
  $('#never-show').click(function() {
    $('#tour-prompt').modal('hide');
    Chain.hideMessage(<%=cmsg%>);
  });
});
<%-end-%>
<%-content_for :action_bar do -%>
  <button class='btn btn_link' link_to='<%=url_for survey_response_path(@cap.survey_response)%>'>Back</button>
  <button class='btn' onclick='$("#hidden-save").click();' id='btn-save'>Save</button>
  <%-if @cap.status!=@cap.class::STATUSES[:active] && @cap.can_edit?(current_user) -%>
  <%=button_to 'Activate', activate_survey_response_corrective_action_plan_path(@cap.survey_response,@cap), :method=>:put, :form_class=>"inline-button-to", :class=>'btn btn-inverse', :id=>'btn-activate'%>
  <%-end-%>
  <%-if @cap.can_delete?(current_user)-%>
    <%=button_to 'Delete', survey_response_corrective_action_plan_path(@cap.survey_response,@cap), :method=>:delete, :form_class=>'inline-button-to', :class=>'btn btn-inverse'%>
  <%-end-%>
  <%-if @cap.status==@cap.class::STATUSES[:active] && @cap.can_edit?(current_user)-%>
    <%=button_to 'Resolve', resolve_survey_response_corrective_action_plan_path(@cap.survey_response,@cap), :method=>:put, :form_class=>"inline-button-to", :class=>'btn btn-inverse'%>
  <%-end-%>
<%-end-%>
<style>
  #ca-form label {
    font-weight: bold;
  }
  #ca-form textarea {
    width: 95%;
  }
  #ca-form fieldset {
    padding-bottom: 20px;
  }
  div.comment-container {
    padding-bottom: 20px;
  }
  div.comment-container pre {
    width: 100%;
  }
</style>
<div class='container' ng-app='CorrectiveActionPlanApp' ng-init='survey_response_id = <%=@cap.survey_response_id%>; corrective_action_plan_id= <%=@cap.id%>;'>
  <div ng-controller='CorrectiveActionPlanController'>
    <div class='row'>
      <div class='span12' style='padding-bottom:2em;'>
        <h1 id='plan-title'>Corrective Action Plan</h1>
      </div>
    </div>
    <!-- HEADER -->
    <div class='row'>
      <div class='span6'>
        <div class='row-fluid'>
          <div class='span4'>
            <strong>Survey:</strong>
          </div>
          <div class='span8'>
            <%=link_to @cap.survey_response.survey.name, @cap.survey_response%>
          </div>
        </div>
        <div class='row-fluid' id='status-display'>
          <div class='span4'>
            <strong>Status:</strong>
          </div>
          <div class='span8'>
            <%=@cap.status%>
          </div>
        </div>
      </div>
      <div class='span6'>
        <div class='row-fluid'>
          <div class='span4'>
            <strong>Assigned To:</strong>
          </div>
          <div class='span8'>
            <%=@cap.survey_response.user.full_name%>
          </div>
        </div>
        <div class='row-fluid'>
          <div class='span4'>
            <strong>Created At:</strong>
          </div>
          <div class='span8'>
            <%=l @cap.created_at.to_date%>
          </div>
        </div>
        <div class='row-fluid'>
          <div class='span4'>
            <strong>Created By:</strong>
          </div>
          <div class='span8'>
            <%=@cap.created_by.full_name%>
          </div>
        </div>
      </div>
    </div>
    <!-- END HEADER -->
    <div class='row text-center' ng-show='viewMode=="loading"'>
      <div class='span12'>
        <img src='/images/ajax_load_64.gif' title='Loading...' />
        Loading corrective action plan data...
      </div>
    </div>
    <div class='row text-center' ng-show='viewMode=="saving"'>
      <div class='span12'>
        <img src='/images/ajax_load_64.gif' title='Loading...' />
        Saving your update...
      </div>
    </div>
    <div class='row text-center' ng-show='viewMode=="error"'>
      <div class='span12'>
        There was an error processing your request. Please reload the page.
      </div>
    </div>
    <form id='ca-form' ng-show='viewMode=="edit"'>
      <!-- COMMENTS -->
      <div class='row'>
        <div class='span12'>
          <legend id='comments-title' class='text-info'>Comments</legend>
        </div>
      </div>
      <div class='row comment-container' ng-repeat='comm in cap.comments'>
        <div class='span12 muted'>
          <strong>{{comm.user.full_name}}</strong> wrote:
        </div>
        <div class='span12' ng-bind-html-unsafe='comm.html_body'>
        </div>
      </div>
      <%-unless @cap.status==@cap.class::STATUSES[:resolved]-%>
        <div class='row'>
          <div class='span12'>
            <label for='new_comment'>New Comment:</label'>
            <textarea id='new_comment' ng-model='comment' rows='5'></textarea>
          </div>
        </div>
      <%-end-%>
      <!-- END COMMENTS -->
      <!-- ISSUES -->
      <div class='row' ng-repeat='ci in cap.corrective_issues'>
        <div class='span12'>
          <fieldset>
            <legend class='text-info issue-legend'>
              Issue
              <button ng-hide='ci.id > 0' ng-click='remove(ci)' class=' pull-right btn btn-small btn-danger'>Remove Issue</button>
            </legend>
            <label for='issue-text-{{ci.id}}'>Description</label>
            <div ng-hide='canEdit' ng-bind-html-unsafe='ci.html_description'></div>
            <textarea rows='6' ng-show='canEdit' id='issue-text-{{ci.id}}' ng-model='ci.description'></textarea>
            <label for='suggest-{{ci.id}}'>Suggested Action</label>
            <div ng-hide='canEdit' ng-bind-html-unsafe='ci.html_suggested_action'></div>
            <textarea rows='6' ng-show='canEdit' id='suggest-{{ci.id}}' ng-model='ci.suggested_action'></textarea>
            <label for='action-{{ci.id}}'>Action Taken</label>
            <div ng-hide='canUpdateActions' ng-bind-html-unsafe='ci.html_action_taken'></div>
            <div ng-show='!canUpdateActions && ci.html_action_taken.length==0'><em>Survey recipient has not added information yet.</em></div>
            <textarea rows='6' ng-show='canUpdateActions' id='action-{{ci.id}}' ng-model='ci.action_taken'></textarea>
          </fieldset>
        </div>
      </div>
      <%-if @cap.can_edit?(current_user) && @cap.status!=@cap.class::STATUSES[:resolved]-%>
        <div class='row'>
          <div class='span12'>
            <button ng-click='addIssue()' class='btn' id='add-issue'>Add Issue</button>
          </div>
        </div>
      <%-end-%>
      <!-- END ISSUES -->
    </form>
    <button style='display:none' ng-click='save()' id='hidden-save'>Save</button>
  </div>
</div>
<div id='tour-prompt' class='modal hide fade'>
  <div class='modal-header'>
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3>Corrective Action Plan</h3>
  </div>
  <div class='modal-body'>
    <p>
      Welcome to the corrective action plan.  Click the button below for a tour.
    </p>
  </div>
  <div class='modal-footer'>
    <button class='btn' id='never-show'>Never Show This Again</button>
    <button class='btn btn-primary' id='show-tour'>Tour</button>
  </div>
</div>
