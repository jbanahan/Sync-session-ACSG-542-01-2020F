<% content_for :javascript do %>
  $(function() {
    $('.unread .collapse').each(function(){
      $(this).on('show.bs.collapse', function() {
        var id = $(this).attr("id").match(/(\d+)$/g)[0];
        var panel = $("#panel-"+id);
        if (panel.hasClass("unread")) {
          panel.removeClass("unread");
          panel.addClass("read");

          $.get('/messages/'+id+'/read',function(data) {
            if(data>0) {
              $('#message_envelope').show();
            } else {
              $('#message_envelope').hide();
            }
            Chain.messagePoller.getMessageCount('/messages/message_count?user_id=<%=current_user.id%>');
          });
        }
      });
    });

    $("#btn_read_all").click(function() {
        $.get('<%=read_all_messages_path%>');
        $('.unread').each(function() {
          $(this).removeClass("unread");
          $(this).addClass("read");
        });
        Chain.messagePoller.getMessageCount('/messages/message_count?user_id=<%=current_user.id%>');
      });

    $(".btn_delete").each(function() {
      $(this).click(function() {
        var id = $(this).attr("id").match(/(\d+)$/g)[0]
        if ( confirm("Are you sure you want to delete this message?") ) {
          $.ajax({
              url: '/messages/'+id,
              type: 'post',
              data: { '_method': 'delete' }
          });            
          Chain.messagePoller.getMessageCount('/messages/message_count?user_id=<%=current_user.id%>');
          $("#panel-"+id).effect('fade', function() {
            $(this).remove();
          });
        }          
      });
    });
  });
<% end %>

<% content_for :action_bar do %>
<button id='btn_read_all'>Mark All Read</button>
<% if(current_user.sys_admin?)%>
  <button class='btn_link' link_to='<%=new_message_path%>'>Send</button>
<%end%>
<% end %>
<%= form_tag users_email_new_message_path, :remote => true, :id => :email_form, :class=>'form-horizontal' do  %>
<%= check_box_tag(:email_new_messages, true, User.current.email_new_messages, { :onclick => "$('#email_form').submit();" }) %> Email me when I have a new message
<% end %>

<div class="panel-group" style="margin-top: 10px">
  <%- @messages.each do |message| %>
    <div class="panel panel-default <%=message.viewed ? 'read' : 'unread'%>" id="panel-<%=message.id%>">
      <div class="panel-heading">
        <h3 class="panel-title" data-toggle="collapse" data-target="#msg-<%=message.id%>" style="cursor: pointer;">
          <div style="float: left;"><%=(message.subject.empty? ? '[No Subject]' : message.subject)%></div>
          <div style="float: right;">Sent At: <%= message.created_at%></div>
          <div class="clear"></div>
        </h3>
      </div>
      <div id="msg-<%=message.id%>" class="panel-collapse collapse">
        <div class="panel-body">
          <%= raw message.body%>
          <p class='text-right'>
            <button class='btn_delete btn btn-sm btn-danger' id='bs_btn_delete_<%=message.id%>'>Delete</button>
          </p>
        </div>
      </div>
    </div>
  <%- end %>  
</div>

<%= will_paginate @messages %>
<div class='container' style='margin-top:1em;'>
  <div class='row'>
    <div class='col-md-6 col-md-offset-3 text-center'>
      <strong>All messages are deleted after 30 days.</strong>
    </div>
  </div>
</div>
