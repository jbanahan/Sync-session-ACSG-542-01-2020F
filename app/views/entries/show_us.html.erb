<%rule_state_field = ModelField.find_by_uid(:ent_rule_state)%>
<%content_for :action_bar do -%>
  <%pms = params.clone-%>
  <%pms[:mode]='simple'-%>
  <button class='btn_link' link_to='<%=entry_path(@entry,pms)%>'>Simple Mode</button>
  <%if current_user.company.master?-%>
    <button class='btn_link' link_to='<%=get_images_entry_path(@entry)%>'>Update Images</button>
  <%end-%>
  <%if rule_state_field.can_view? current_user%>
    <button class='btn_link' link_to='<%=validation_results_entry_path(@entry)%>'>Business Rules</button>
  <%end%>
<%end-%>
<% cache ["v7",current_user.company,current_user,@entry] do-%>
  <style>
  .ent_columns {
    width:99%;
  }
  .ent_columns tbody {
    vertical-align:top;
  }
  .ent_columns .label_cell {
    width:0;
  }
  .quick_jump {
    text-align: center;
    margin-bottom: 5px;
  }
  .qj_label {
    font-weight: bold;
    padding-right: 1em;
  }
  .ci_line td {
    border-top: 1px solid #333;
  }
  </style>
  <%show_broker_invoices = current_user.view_broker_invoices? && !@entry.broker_invoices.blank?%>
  <%=render partial: 'business_rules', locals:{entry:@entry}%>
  <a name='ent_header'></a>
  <div class='quick_jump'>
    <a href='#c_invoices'>Commercial Invoices</a>
    <%if show_broker_invoices%> | <a href='#b_invoices'>Broker Invoices</a><%end%>
  </div>
  <!-- Main header -->
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:33%;">
          <table>
            <%[:ent_entry_num,:ent_brok_ref,:ent_customer_references,:ent_mbols,:ent_hbols].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:33%;">
          <table>
            <%[:ent_release_cert_message,:ent_fda_message,:ent_paperless_certification,:ent_paperless_release,:ent_census_warning,:ent_error_free_release].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:34%;">
          <table>
            <%[:ent_cust_name,:ent_vendor_names,:ent_po_numbers,:ent_merch_desc].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <!-- Dates -->
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:33%;">
          <table>
            <%[:ent_export_date,:ent_docs_received_date,:ent_isf_sent_date,:ent_isf_accepted_date,:ent_first_it_date,:ent_filed_date,:ent_first_entry_sent_date,:ent_eta_date,:ent_arrival_date,:ent_release_date].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:33%;">
          <table>
            <%[:ent_fda_transmit_date,:ent_fda_review_date,:ent_fda_release_date,:ent_trucker_called_date, :ent_delivery_order_pickup_date, :ent_freight_pickup_date, :ent_free_date,:ent_duty_due_date].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:34%;">
          <table>
            <%[:ent_last_billed_date,:ent_invoice_paid_date,:ent_edi_received_date,:ent_file_logged_date,:ent_first_7501_print,:ent_last_7501_print,:ent_last_exported_from_source].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:33%;">
          <table>
            <%e_port_name_f = ModelField.find_by_uid(:ent_entry_port_name)%>
            <%=field_row e_port_name_f.label(false), "<a href='/entries/importer/#{@entry.importer_id}/entry_port/#{@entry.entry_port_code}'>#{e_port_name_f.process_export(@entry,current_user)}<span class='glyphicon glyphicon-link' style='font-size:80%;'></span></a>".html_safe%>
            <%[
              :ent_lading_port_name, :ent_unlading_port_name, :ent_destination_state,
              :ent_type,:ent_mfids,:ent_export_country_codes,:ent_origin_country_codes,:ent_spis,:ent_vessel,:ent_voyage
            ].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:33%;">
          <table>
            <%[:ent_ult_con_name,:ent_transport_mode_code,:ent_carrier_code,:ent_sbols,:ent_it_numbers,:ent_container_nums, :ent_container_sizes,:ent_fcl_lcl,:ent_ult_con_code,:ent_cust_num,:ent_comp_num,:ent_div_num,:ent_recon_flags].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:34%;">
          <table>
            <%[:ent_total_fees,:ent_total_duty,:ent_total_duty_direct,:ent_cotton_fee, :ent_hmf, :ent_mpf,:ent_entered_value,:ent_total_invoiced_value,:ent_gross_weight,:ent_total_units,:ent_total_units_uoms,:ent_total_packages,:ent_total_packages_uom, :ent_broker_invoice_total, :ent_duty_billed].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <% entry_comments = @entry.entry_comments.order("generated_at ASC").select {|c| c.can_view? current_user} -%>
  <% if !entry_comments.empty? -%>
  <h2>Notes</h2>
  <table class='detail_table'>
    <%entry_comments.each do |c|
      if c.can_view? current_user -%>
        <tr class='hover'><td><%=c.body%></td><td><%=c.generated_at%></td><td><%=c.username%></td></tr>
      <%end-%>
    <%end-%>
  </table>
  <hr />
  <%end-%>
  <% if @entry.liquidation_data? -%>
  <h2>Liquidation</h2>
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:50%;">
          <table>
            <%[:ent_liq_date,:ent_liquidation_total,:ent_liquidation_duty,:ent_liquidation_fees,:ent_liquidation_tax,:ent_liquidation_ada,:ent_liquidation_cvd
            ].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:50%;">
          <table>
            <%[:ent_liquidation_type,:ent_liquidation_type_code,:ent_liquidation_action_description,:ent_liquidation_action_code,:ent_liquidation_extension_description,:ent_liquidation_extension_code,:ent_liquidation_extension_count].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <%end-%>
  <h2>Statement</h2>
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:50%;">
          <table>
            <%[:ent_pay_type,:ent_daily_statement_number,:ent_daily_statement_due_date,:ent_daily_statement_approved_date].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
        <td style="width:50%;">
          <table>
            <%[:ent_statement_month,:ent_monthly_statement_number,:ent_monthly_statement_due_date,:ent_monthly_statement_received_date,:ent_monthly_statement_paid_date].each do |f|%>
              <%=field_view_row @entry, f %>
            <%end%>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <a name='c_invoices'></a>
  <div class='quick_jump'>
    <a href='#ent_header'>Top</a> 
    <% if show_broker_invoices %>
      | <a href='#b_invoices'>Broker Invoices</a>
    <% end %>
  </div>
  <%ci_line_count = @entry.commercial_invoice_lines.count  %>
  <%if @entry.commercial_invoices.count >0%>
    <h1>Commercial Invoices</h1>
    <%ci_summary_fields = [:ci_invoice_number,:ci_vendor_name,:ci_invoice_value,:ci_gross_weight]%>
    <table class='detail_table'>
      <thead><tr>
        <%ci_summary_fields.each do |f|%>
          <th><%=field_label f, false%></th>
        <%end%>
      </tr></thead>
      <tbody>
        <%@entry.commercial_invoices.each do |ci|%>
          <tr class='hover'>
            <%ci_summary_fields.each do |f|%>
              <%if ci_line_count < 200%>
                <td><%=f==:ci_invoice_number ? link_to(field_value(ci,f),"#ci_#{ci.id}") : field_value(ci, f)%></td>
              <%else  %>
                <td><%=field_value(ci, f)%></td>
              <%end  %>
            <%end%>
          </tr>
        <%end%>
      </tbody>
    </table>
    <hr />
  <% end%>
  <%if ci_line_count < 200%>
    <%@entry.commercial_invoices.each do |ci|%>
      <a name='ci_<%=ci.id%>'></a>
      <table class='ent_columns'>
        <tbody>
          <tr><td colspan='2'><h3><%=field_label :ci_invoice_number, false%> - <%=field_value(ci,:ci_invoice_number)%></h3></td></tr>
          <tr>
            <td style='width:50%;'>
              <table>
                <%[:ci_vendor_name,:ci_mfid,:ci_invoice_date,:ci_gross_weight,:ci_country_origin_code].each do |f|%>
                  <%=field_view_row ci,f,false%>
                <%end%>
              </table>
            </td>
            <td style='width:50%;'>
              <table>
                <%[:ci_invoice_value,:ci_total_charges,:ci_invoice_value_foreign,:ci_currency, :ci_total_quantity, :ci_total_quantity_uom].each do |f|%>
                  <%=field_view_row ci,f,false%>
                <%end%>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
      <%fields = [:cil_part_number,:cil_po_number,:cil_units,:cil_uom,:cil_value,:cil_country_origin_code,:cil_country_export_code,:cil_department,:cil_related_parties,:cil_volume,:cil_hmf,:cil_prorated_mpf,:cil_cotton_fee, :cil_contract_amount]%>
      <table class='detail_table'>
        <thead><tr>
          <%fields.each do |f|%>
            <th><%=field_label f, false%></th>
          <%end%>
        </tr></thead>
        <tbody>
          <%ci.commercial_invoice_lines.each do |line|%>
            <tr class='hover ci_line'>
              <%fields.each_with_index do |f,i|%>
                <td <%="rowspan='2'" if i==0%> <%="style='text-align:right;'" if [:decimal,:integer].include? ModelField.find_by_uid(f).data_type%>><%=field_value(line, f)%></td>
              <%end%>
            </tr>
            <% 
            # Don't bother showing CVD or ADD fields if there's no values to show.  We can determine if there's something to show 
            # by checking if add/cvd case number is non-null, since the Alliance files don't include the CVD/ADD line types 
            # unless that data is applicable to the invoice.  Even if there's no actual case #, the value in those cases will be '', not nil
            if ci.commercial_invoice_lines.find {|line| !line.add_case_number.nil?} %>
              <tr>
                <td colspan='<%=fields.length%>' style='font-size:111%;'>
                  <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:cil_add_case_number, :cil_add_bond, :cil_add_case_value, :cil_add_duty_amount, :cil_add_case_percent],
                      :lines=>[line]}%>
                </td>
              </tr>
            <% end %>
            <% if ci.commercial_invoice_lines.find {|line| !line.cvd_case_number.nil?} %>
              <tr>
                <td colspan='<%=fields.length%>' style='font-size:111%;'>
                  <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:cil_cvd_case_number, :cil_cvd_bond, :cil_cvd_case_value, :cil_cvd_duty_amount, :cil_cvd_case_percent],
                      :lines=>[line]}%>
                </td>
              </tr>
            <% end %>
            <% if line.commercial_invoice_tariffs.count > 0%>
              <tr>
                <td colspan='<%=fields.length%>' style='font-size:111%; padding-left:0.5em;'>
                  <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:cit_hts_code,:cit_duty_amount,:cit_entered_value,:cit_duty_rate,:cit_spi_primary,:cit_spi_secondary,
                    :cit_classification_qty_1,:cit_classification_uom_1,:cit_classification_qty_2,:cit_classification_uom_2,:cit_classification_qty_3,:cit_classification_uom_3,
                    :cit_gross_weight,:cit_tariff_description], :lines=>line.commercial_invoice_tariffs, 
                    :overrides=>{:cit_hts_code=>lambda {|mf,line| show_tariff(line.hts_code,line.entry.import_country_id,true)}}}%>
                </td>
              </tr>
            <% end %>
          <%end%>
        </tbody>
      </table>
      <hr />
    <%end%>
  <%else%>
    <h3>More than 200 commercial invoice lines exist.  Please use the <a href='/entries'>search module</a> to report on commercial invoice details.</h3>
  <%end%>
  <%if show_broker_invoices%>
    <a name='b_invoices'></a>
    <div class='quick_jump'>
      <a href='#ent_header'>Top</a> |
      <a href='#c_invoices'>Commercial Invoices</a>
    </div>
    <h1>Broker Invoices</h1>
    <%fields = [:bi_invoice_number,:bi_invoice_date,:bi_suffix,:bi_invoice_total,:bi_currency]%>
    <table class='detail_table'>
      <thead><tr>
        <%fields.each do |f|%>
          <th><%=field_label f, false%></th>
        <%end%>
      </tr></thead>
      <tbody>
        <%@entry.broker_invoices.each do |line|%>
          <%if line.can_view? current_user %>
            <tr class='hover'>
              <%fields.each do |f|%>
                <td <%="style='text-align:right;'" if [:decimal,:integer].include? ModelField.find_by_uid(f).data_type%>>
                  <%=f==:bi_invoice_number ? link_to(field_value(line,f),"#bi_#{line.id}") : field_value(line, f)%>
                </td>
              <%end%>
            </tr>
          <% end %>
        <%end%>
      </tbody>
    </table>
    <hr />
    <%@entry.broker_invoices.each do |bi|%>
      <% if bi.can_view? current_user%>
        <a name='bi_<%=bi.id%>'></a>
        <table class='ent_columns'>
          <tbody>
            <tr><td colspan='2'><h3><%=field_label :bi_invoice_date, false%> - <%=field_value(bi,:ci_invoice_date)%></h3></td></tr>
            <tr>
              <td style='width:50%;'>
                <table>
                  <%[:bi_invoice_number,:bi_suffix,:bi_invoice_total,:bi_currency].each do |f|%>
                    <%=field_view_row bi,f,false%>
                  <%end%>
                </table>
              </td>
              <td style='width:50%;'>
                <table>
                  <%[:bi_to_name,:bi_to_add1,:bi_to_add2,:bi_to_city,:bi_to_state,:bi_to_zip,:bi_to_country_iso].each do |f|%>
                    <%=field_view_row bi,f,false%>
                  <%end%>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
        <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:bi_line_charge_code,:bi_line_charge_description,:bi_line_charge_amount,:bi_line_vendor_name,:bi_line_vendor_reference,:bi_line_charge_type],:lines=>bi.broker_invoice_lines}%>
        <%=secure_link bi, current_user%>
      <% end %>
    <%end%>
  <%end%>
<%end-%>
  <%=render :partial => 'shared/attachments', :locals => {:attachable => @entry, :width=>"wide"} %>
  <br />
  <%=secure_link @entry, current_user%>
