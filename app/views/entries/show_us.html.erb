<%content_for :action_bar do -%>
  <%pms = params.clone-%>
  <%pms[:mode]='simple'-%>
  <button title='Simple Mode' class='btn_link' link_to='<%=entry_path(@entry,pms)%>'><i class='fa fa-search-minus'></i></button>
  <%if current_user.company.master?-%>
    <%= link_to raw("<i class='fa fa-file-image-o'></i>"), get_images_entry_path(@entry), title:'Update Images', class: 'btn navbar-btn btn-default', form_class: 'inline-button-to inline-navbar-button', method: 'POST', style:'margin-right: -1px;'%>
    <%= link_to raw("<i class='fa fa-refresh'></i>"), request_entry_data_entry_path(@entry), class: 'btn navbar-btn btn-default', form_class: 'inline-button-to inline-navbar-button', style:'margin-right: -1px;', method: 'POST', title: 'Update Entry' %>
  <%end-%>
  <%if current_user.sys_admin?-%>    
    <%= link_to raw("<i class='fa fa-trash'></i>"), purge_entry_path(@entry), method: "POST",  data: { confirm: 'Purging an entry will delete it forever.  Are you certain you want to purge this entry?'}, class: 'btn navbar-btn btn-default', form_class: 'inline-button-to inline-navbar-button', style:'margin-right: -1px;', method: 'POST', title: 'Purge' %>
  <%end-%>
  <%if current_user.company.master?-%>
    <%= link_to raw("<i class='fa fa-truck'></i>"), generate_delivery_order_entry_path(@entry), title:'Generate Delivery Order', class: 'btn navbar-btn btn-default', form_class: 'inline-button-to inline-navbar-button', method: 'POST', style:'margin-right: -1px;'%>
  <% end-%>
  <button title='Download' id="ent_download" class="btn_link" link_to="<%=entry_path(@entry, format: :xls)%>"><i class='fa fa-download'></i></button>
  <button class="btn_link" title='Sync Records' link_to='<%=sync_records_entry_path(@entry)%>'><i class='fa fa-exchange'></i></button>
<%end-%>
<%content_for :javascript do %>
$(function() {
  toggleComments = function(link) {
    toggleType = link.attr('data-message-toggle-type');
    isOn = link.attr('data-message-toggle-val')=="on";
    comments = $("[data-comment-type='"+toggleType+"']");
    if(isOn) {
      comments.hide();
      link.attr('data-message-toggle-val','off');
      link.find('i.fa').removeClass('fa-check-square-o').addClass('fa-square-o');
    } else {
      comments.show();
      link.attr('data-message-toggle-val','on');
      link.find('i.fa').removeClass('fa-square-o').addClass('fa-check-square-o');
    }
  }
  $("[data-message-toggle-type]").click(function(evt) {
    evt.preventDefault();
    link = $(this);
    toggleComments(link);
  });
});
<%end%>
<div class='container'>
  <%=render partial: '/shared/business_rules', locals:{base_object:@entry,rule_state_field:ModelField.find_by_uid(:ent_rule_state), validation_path: validation_results_entry_path(@entry)}%>
</div>
<% cache [current_user.company,current_user,@entry] do-%>
  <style>
  .ent_columns {
    width:99%;
  }
  .ent_columns tbody {
    vertical-align:top;
  }
  .ent_columns .label_cell {
    width:0;
  }
  .quick_jump {
    text-align: center;
    margin-bottom: 5px;
  }
  .qj_label {
    font-weight: bold;
    padding-right: 1em;
  }
  .ci_line td {
    border-top: 1px solid #333;
  }
  </style>
  <%show_broker_invoices = current_user.view_broker_invoices? && !@entry.broker_invoices.blank?%>
  <a name='ent_header'></a>
  <div class='quick_jump'>
    <a href='#c_invoices'>Commercial Invoices</a>
    <%if show_broker_invoices%> | <a href='#b_invoices'>Broker Invoices</a><%end%>
  </div>
  <!-- Main header -->
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:33%;">
          <table>
            <%= show_model_fields @entry, [:ent_entry_num,:ent_brok_ref,:ent_customer_references,:ent_mbols,:ent_hbols], table: true %>
          </table>
        </td>
        <td style="width:33%;">
          <table>
            <%= show_model_fields @entry, [:ent_release_cert_message,:ent_fda_message,:ent_paperless_certification,:ent_paperless_release,:ent_census_warning,:ent_error_free_release], table: true %>
          </table>
        </td>
        <td style="width:34%;">
          <table>
            <%= show_model_fields @entry, [:ent_cust_name,:ent_vendor_names,:ent_po_numbers,:ent_merch_desc], table: true %>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <!-- Dates -->
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:33%;">
          <table>
            <%= show_model_fields @entry, [:ent_export_date,:ent_bol_received_date, :ent_docs_received_date,:ent_isf_sent_date,:ent_isf_accepted_date,:ent_first_it_date,:ent_filed_date,:ent_first_entry_sent_date,:ent_eta_date,:ent_arrival_date,:ent_release_date], table: true %>
          </table>
        </td>
        <td style="width:33%;">
          <table>
            <%= show_model_fields @entry, [:ent_fda_transmit_date,:ent_fda_review_date,:ent_fda_release_date,:ent_trucker_called_date, :ent_delivery_order_pickup_date, :ent_freight_pickup_date, :ent_final_delivery_date, :ent_free_date,:ent_duty_due_date], table: true %>
          </table>
        </td>
        <td style="width:34%;">
          <table>
            <%= show_model_fields @entry, [:ent_last_billed_date,:ent_invoice_paid_date,:ent_edi_received_date,:ent_file_logged_date,:ent_first_7501_print,:ent_last_7501_print,:ent_last_exported_from_source,:ent_cancelled_date], table: true %>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:33%;">
          <table>
            <%= show_model_fields @entry, :ent_entry_port_name, table: true, wrap_with: lambda {|mf, editor| !editor.blank? ? "<a href='/entries/importer/#{@entry.importer_id}/entry_port/#{@entry.entry_port_code}'>#{editor} <span class='glyphicon glyphicon-link' style='font-size:80%;'></span></a>".html_safe : ""} %>
            <%= show_model_fields @entry, [:ent_lading_port_name, :ent_unlading_port_name, :ent_destination_state,:ent_type,:ent_mfids,:ent_export_country_codes,:ent_origin_country_codes,:ent_spis,:vessel,:ent_voyage], table: true %>
          </table>
        </td>
        <td style="width:33%;">
          <table>
          <%= show_model_fields @entry, [:ent_ult_con_name,:ent_transport_mode_code,:ent_carrier_code,:ent_house_carrier_code,:ent_sbols,:ent_it_numbers,:ent_container_nums, :ent_container_sizes,:ent_fcl_lcl,:ent_ult_con_code,:ent_cust_num,:ent_comp_num,:ent_div_num,:ent_recon_flags], table: true %>
          </table>
        </td>
        <td style="width:34%;">
          <table>
            <%= show_model_fields @entry, [:ent_total_fees,:ent_total_duty,:ent_total_duty_direct,:ent_cotton_fee, :ent_hmf, :ent_mpf,:ent_entered_value,:ent_total_invoiced_value,:ent_gross_weight,:ent_total_units,:ent_total_units_uoms,:ent_total_packages,:ent_total_packages_uom, :ent_broker_invoice_total, :ent_duty_billed], table: true %>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <% entry_comments = @entry.entry_comments.order("generated_at ASC").select {|c| c.can_view? current_user} -%>
  <% if !entry_comments.empty? -%>
  <h2>
    Notes
    <div class="pull-right">
      <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Filter <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a href="#" data-message-toggle-type='ABI' data-message-toggle-val='on'><i class='fa fa-check-square-o'></i> CBP</a></li>
          <li><a href="#" data-message-toggle-type='ISF' data-message-toggle-val='on'><i class='fa fa-check-square-o'></i> ISF</a></li>
          <li><a href="#" data-message-toggle-type='SYSTEM' data-message-toggle-val='on'><i class='fa fa-check-square-o'></i> System</a></li>
          <li><a href="#" data-message-toggle-type='USER' data-message-toggle-val='on'><i class='fa fa-check-square-o'></i> User</a></li>
        </ul>
      </div>
    </div>
  </h2>
  <table class='table table-condensed'>
    <%entry_comments.each do |c|
      if c.can_view? current_user -%>
        <tr class='hover' data-comment-type='<%=c.comment_type%>'><td><%=c.body%></td><td><%=c.generated_at%></td><td><%=c.username%></td></tr>
      <%end-%>
    <%end-%>
  </table>
  <hr />
  <%end-%>
  <% if @entry.liquidation_data? -%>
  <h2>Liquidation</h2>
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:50%;">
          <table>
            <%= show_model_fields @entry, [:ent_liq_date,:ent_liquidation_total,:ent_liquidation_duty,:ent_liquidation_fees,:ent_liquidation_tax,:ent_liquidation_ada,:ent_liquidation_cvd], table: true %>
          </table>
        </td>
        <td style="width:50%;">
          <table>
            <%= show_model_fields @entry, [:ent_liquidation_type,:ent_liquidation_type_code,:ent_liquidation_action_description,:ent_liquidation_action_code,:ent_liquidation_extension_description,:ent_liquidation_extension_code,:ent_liquidation_extension_count], table: true %>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <%end-%>
  <h2>Statement</h2>
  <table class='ent_columns'>
    <tbody>
      <tr>
        <td style="width:50%;">
          <table>
            <%= show_model_fields @entry, [:ent_pay_type,:ent_daily_statement_number,:ent_daily_statement_due_date,:ent_daily_statement_approved_date], table: true %>
          </table>
        </td>
        <td style="width:50%;">
          <table>
            <%= show_model_fields @entry, [:ent_statement_month,:ent_monthly_statement_number,:ent_monthly_statement_due_date,:ent_monthly_statement_received_date,:ent_monthly_statement_paid_date], table: true %>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <hr />
  <a name='c_invoices'></a>
  <div class='quick_jump'>
    <a href='#ent_header'>Top</a> 
    <% if show_broker_invoices %>
      | <a href='#b_invoices'>Broker Invoices</a>
    <% end %>
  </div>
  <%ci_line_count = @entry.commercial_invoice_lines.count  %>
  <%if @entry.commercial_invoices.count >0%>
    <h1>Commercial Invoices</h1>
    <%ci_summary_fields = [:ci_invoice_number,:ci_vendor_name,:ci_invoice_value,:ci_gross_weight]%>
    <table class='detail_table'>
      <thead>
        <tr>
          <%= model_field_labels ci_summary_fields, table: true, heading: true  %>
        </tr>
      </thead>
      <tbody>
        <%@entry.commercial_invoices.each do |ci|%>
          <tr class='hover'>
            <%ci_summary_fields.each do |f|%>
              <%if ci_line_count < 200 && f==:ci_invoice_number %>
                <%= show_model_fields ci, f, table:true, editor_only: true, wrap_with: lambda {|mf, value| link_to(value, "#ci_#{ci.id}")} %>
              <% else %>
                <%= show_model_fields ci, f, table:true, editor_only: true %>
              <% end %>
            <%end%>
          </tr>
        <%end%>
      </tbody>
    </table>
    <hr />
  <% end%>
  <%if ci_line_count < 200%>
    <%@entry.commercial_invoices.each do |ci|%>
      <a name='ci_<%=ci.id%>'></a>
      <table class='ent_columns'>
        <tbody>
          <tr>
            <td colspan='2'>
              <h3><%= model_field_labels :ci_invoice_number %><%= show_model_fields ci, :ci_invoice_number, editor_only: true, wrap_with: lambda {|mf, value| (" - " + value).html_safe} %></h3>
            </td>
          </tr>
          <tr>
            <td style='width:50%;'>
              <table>
                <%= show_model_fields ci, [:ci_vendor_name,:ci_mfid,:ci_invoice_date,:ci_gross_weight,:ci_country_origin_code], table:true %>
              </table>
            </td>
            <td style='width:50%;'>
              <table>
                <%= show_model_fields ci, [:ci_invoice_value,:ci_total_charges,:ci_invoice_value_foreign,:ci_currency, :ci_total_quantity, :ci_total_quantity_uom], table:true %>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
      <%fields = ModelField.viewable_model_fields(current_user, [:cil_part_number,:cil_po_number,:cil_units,:cil_uom,:cil_value,:cil_country_origin_code,:cil_country_export_code,:cil_department,:cil_related_parties,:cil_volume,:cil_hmf,:cil_prorated_mpf,:cil_cotton_fee, :cil_contract_amount])%>
      <table class='table table-condensed table-bordered'>
        <thead>
          <tr>
            <%= model_field_labels fields, table: true, heading: true %>
          </tr>
        </thead>
        <tbody>
          <%ci.commercial_invoice_lines.each do |line|%>
            <tr class='hover ci_line'>
              <%fields.each_with_index do |f,i|%>
                <%= show_model_fields line, f, editor_only: true, table: true %>
              <%end%>
            </tr>
            <% 
            # Don't bother showing CVD or ADD fields if there's no values to show.  We can determine if there's something to show 
            # by checking if add/cvd case number is non-null, since the Alliance files don't include the CVD/ADD line types 
            # unless that data is applicable to the invoice.  Even if there's no actual case #, the value in those cases will be '', not nil
            if !line.add_case_number.blank? %>
              <tr>
                <td colspan='<%=fields.length%>' style='font-size:111%; padding-left:0.5em;'>
                  <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:cil_add_case_number, :cil_add_bond, :cil_add_case_value, :cil_add_duty_amount, :cil_add_case_percent],
                      :lines=>[line]}%>
                </td>
              </tr>
            <% end %>
            <% if !line.cvd_case_number.blank? %>
              <tr>
                <td colspan='<%=fields.length%>' style='font-size:111%; padding-left:0.5em;'>
                  <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:cil_cvd_case_number, :cil_cvd_bond, :cil_cvd_case_value, :cil_cvd_duty_amount, :cil_cvd_case_percent],
                      :lines=>[line]}%>
                </td>
              </tr>
            <% end %>
            <% if line.commercial_invoice_tariffs.length > 0%>
              <tr>
                <td>&nbsp;</td>
                <td colspan='<%=fields.length-1%>' align='right'>
                  <%=render partial: "commercial_invoice_tariffs", locals: {commercial_invoice_line: line, entry: @entry} %>
                </td>
              </tr>
            <% end %>
          <%end%>
        </tbody>
      </table>
      <hr />
    <%end%>
  <%else%>
    <h3>More than 200 commercial invoice lines exist.  Please <a href="<%=entry_path(@entry, format: :xls)%>">download</a> the entry data or use the <a href='/entries'>search module</a> to report on commercial invoice details.</h3>
  <%end%>
  <%if !@entry.containers.blank?%>
    <a name='containers'></a>
    <h1>Containers</h1>
    <table class="detail_table">
      <thead>
        <tr>
          <th>Number</th>
          <th>Size</th>
          <th>Weight</th>
          <th>Quantity</th>
          <th>Description</th>
          <th>FCL/LCL</th>
          <th>TEUs</th>
        </tr>
      </thead>
      <tbody>
        <%@entry.containers.each do |cont|%>
        <tr>
          <td><%=cont.container_number%></td>
          <td><%=cont.container_size%> <%=cont.size_description%></td>
          <td><%=cont.weight%> KGS</td>
          <td><%=cont.quantity%> <%=cont.uom%></td>
          <td><%=cont.goods_description%></td>
          <td><%=cont.fcl_lcl%></td>
          <td><%=cont.teus%></td>
        </tr>
        <%end%>
      </tbody>
    </table>
  <%end%>
  <%if show_broker_invoices%>
    <a name='b_invoices'></a>
    <div class='quick_jump'>
      <a href='#ent_header'>Top</a> |
      <a href='#c_invoices'>Commercial Invoices</a>
    </div>
    <h1>Broker Invoices</h1>
    <%
      fields = [:bi_invoice_number,:bi_invoice_date,:bi_suffix,:bi_invoice_total,:bi_currency]
      # The need for the order by here is due to the possibility of updating invoices in the kewill parser, which will mean that
      # invoices may be out of chronological order if we just showed them in order by database id.
      broker_invoices = @entry.broker_invoices.order(:invoice_date, :invoice_number).to_a
    %>
    <table class='detail_table'>
      <thead>
        <tr>
          <%= model_field_labels fields, table: true, heading: true  %>
        </tr>
      </thead>
      <tbody>
        <%broker_invoices.each do |line|%>
          <%if line.can_view? current_user %>
            <tr class='hover'>
              <%= show_model_fields line, fields, table: true, editor_only: true, bi_invoice_number: {wrap_with: lambda{|mf, value| link_to(value, "#bi_#{line.id}")}} %>
            </tr>
          <% end %>
        <%end%>
      </tbody>
    </table>
    <hr />
    <%broker_invoices.each do |bi|%>
      <% if bi.can_view? current_user%>
        <a name='bi_<%=bi.id%>'></a>
        <table class='ent_columns'>
          <tbody>
            <tr>
              <td colspan='2'>
                <h3><%= model_field_labels :bi_invoice_date %><%= show_model_fields bi, :bi_invoice_date, editor_only: true, wrap_with: lambda {|mf, value| (" - " + value).html_safe} %></h3>
              </td>
            </tr>
            <tr>
              <td style='width:50%;'>
                <table>
                  <%= show_model_fields bi, [:bi_invoice_number,:bi_suffix,:bi_invoice_total,:bi_currency], table:true %>
                </table>
              </td>
              <td style='width:50%;'>
                <table>
                  <%= show_model_fields bi, [:bi_to_name,:bi_to_add1,:bi_to_add2,:bi_to_city,:bi_to_state,:bi_to_zip,:bi_to_country_iso], table:true %>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
        <%# The following needs to be here so cache_digests recognizes the shared/detail_table partial as a cache dependency...not sure
            exactly why it doesn't already see it since the partial is used exactly the same as the others, but it's not. (bug?) %>
        <%# Template Dependency: shared/detail_table %>
        <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:bi_line_charge_code,:bi_line_charge_description,:bi_line_charge_amount,:bi_line_vendor_name,:bi_line_vendor_reference,:bi_line_charge_type],:lines=>bi.broker_invoice_lines} %>
        <%=secure_link bi, current_user%>
      <% end %>
    <%end%>
  <%end%>
<%end-%>
  <%=render :partial => 'shared/attachments', :locals => {:attachable => @entry, :width=>"wide"} %>
  <br />
  <%=secure_link @entry, current_user%>
