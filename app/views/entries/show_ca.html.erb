<%rule_state = @entry.business_rules_state_for_user(current_user)%>
<%content_for :action_bar do -%>
  <button class="btn_link" link_to="<%=entry_path(@entry, format: :xlsx)%>" title='Download'><i class='fa fa-download'></i></button>
  <button class="btn_link" link_to='<%=sync_records_entry_path(@entry)%>' title='Sync Records'><i class='fa fa-exchange'></i></button>
  <%if current_user.sys_admin?-%>    
    <%= link_to raw("<i class='fa fa-trash'></i>"), purge_entry_path(@entry), method: "POST",  data: { confirm: 'Purging an entry will delete it forever.  Are you certain you want to purge this entry?'}, class: 'btn navbar-btn btn-default', form_class: 'inline-button-to inline-navbar-button', style:'margin-right: -1px;', title: 'Purge' %>
  <%end-%>
<% end -%>
<style>
.quick_jump {
  text-align: center;
  margin-bottom: 5px;
}
.qj_label {
  font-weight: bold;
  padding-right: 1em;
}
.ci_line td {
  border-top: 1px solid #333;
}
</style>
<%show_broker_invoices = current_user.view_broker_invoices?%>
<div class='container'>
  <%=render partial: '/shared/business_rules', locals:{base_object:@entry,rule_state:rule_state, validation_path: validation_results_entry_path(@entry)}%>
</div>
<% if @entry.on_hold? %>
  <div class='container'>
    <div class="row">
      <div class="col-md-12">
        <div class='panel panel-danger'>
          <div class='panel-heading'>
            <h3 class='panel-title'>Pending Hold</h3>
          </div>
          <div class='panel-body'>
            Entry is currently on hold by CBSA
          </div>
        </div>
      </div>
    </div> 
  </div>
<% end %>
<div class="container">
  <%= render_milestone_markers(current_user, @entry, {fields: @entry.milestone_view_data}) %>
</div>
<a name='ent_header'></a>
<div class='quick_jump'><span class='qj_label'>Jump To:</span>
  <a href='#c_invoices'>Commercial Invoices</a>
  <%if show_broker_invoices%> | <a href='#b_invoices'>Broker Invoices</a><%end%>
</div>
<!-- Main header -->
<table class='ent_columns'>
  <tbody>
    <tr>
      <td style="width:33%;">
        <table>
          <%= show_model_fields @entry, [:ent_entry_num,:ent_brok_ref,:ent_cust_num, :ent_cust_name, :ent_importer_tax_id,:ent_cargo_control_number,
          :ent_ca_entry_type,:ent_po_numbers,
          :ent_vendor_names, :ent_customer_references, :ent_total_units,:ent_total_packages, :ent_total_packages_uom, :ent_gross_weight, :ent_total_invoiced_value,:ent_entered_value,:ent_total_duty,:ent_total_gst,:ent_total_duty_gst], table:true %>
        </table>
      </td>
      <td style="width:33%;">
        <table>
          <%= show_model_fields @entry, [:ent_direct_shipment_date,:ent_eta_date,:ent_across_sent_date,:ent_pars_ack_date,:ent_pars_reject_date,:ent_release_date,:ent_cadex_sent_date,:ent_cadex_accept_date,:ent_duty_due_date,:ent_file_logged_date,:ent_docs_received_date,:ent_first_do_issued_date, :ent_k84_receive_date, :ent_k84_due_date, :ent_exam_ordered_date, :ent_exam_release_date, :ent_b3_print_date], table: true %>
        </table>
      </td>
      <td style="width:34%;">
        <table>
          <%= show_model_fields @entry, :ent_entry_port_name, table: true, wrap_with: lambda {|mf, editor| !editor.blank? ? "<a href='/entries/importer/#{@entry.importer_id}/entry_port/#{@entry.entry_port_code}/country/#{@entry.import_country.try(:iso_code)}'>#{editor} <span class='glyphicon glyphicon-link' style='font-size:80%;'></span></a>".html_safe : ""} %>
          <%= show_model_fields @entry, [:ent_mbols,:ent_hbols,:ent_container_nums,:ent_origin_country_codes,:ent_origin_state_code,:ent_export_country_codes,:ent_export_state_code,:ent_us_exit_port_code,:ent_ship_terms,:ent_transport_mode_code,:ent_carrier_code,:ent_carrier_name,:ent_voyage,:ent_ult_con_name,:ent_employee_name], table: true %>
        </table>
      </td>
    </tr>
  </tbody>
</table>
<hr />
<a name='c_invoices'></a>
<div class='quick_jump'><span class='qj_label'>Jump To:</span>
  <a href='#ent_header'>Top</a> 
  <% if show_broker_invoices %>
    | <a href='#b_invoices'>Broker Invoices</a>
  <% end %>
</div>
<%ci_line_count = @entry.commercial_invoice_lines.count  %>
<%if @entry.commercial_invoices.count >0%>
  <h1>Commercial Invoices</h1>
  <%ci_summary_fields = [:ci_invoice_number,:ci_vendor_name,:ci_invoice_value]%>
  <table class='detail_table'>
    <thead>
      <tr>
         <%= model_field_labels ci_summary_fields, table: true, heading: true  %>
      </tr>
    </thead>
    <tbody>
      <%@entry.commercial_invoices.each do |ci|%>
        <tr class='hover'>
          <%ci_summary_fields.each do |f|%>
            <%if ci_line_count < 200 && f==:ci_invoice_number %>
              <%= show_model_fields ci, f, table:true, editor_only: true, wrap_with: lambda {|mf, value| link_to(value, "#ci_#{ci.id}")} %>
            <% else %>
              <%= show_model_fields ci, f, table:true, editor_only: true %>
            <% end %>
          <%end%>
        </tr>
      <%end%>
    </tbody>
  </table>
  <hr />
<% end%>
<%if ci_line_count < 200%>
  <%@entry.commercial_invoices.each do |ci|%>
    <a name='ci_<%=ci.id%>'></a>
    <table class='ent_columns'>
      <tbody>
        <tr>
          <td colspan='2'>
            <h3><%= model_field_labels :ci_invoice_number %><%= show_model_fields ci, :ci_invoice_number, editor_only: true, wrap_with: lambda {|mf, value| (" - " + value).html_safe} %></h3>
          </td>
        </tr>
        <tr>
          <td style='width:50%;'>
            <table>
              <%= show_model_fields ci, [:ci_vendor_name,:ci_invoice_date,:ci_invoice_value], table:true %>
            </table>
          </td>
          <td style='width:50%;'>
            <table>
              <%= show_model_fields ci, [:ci_currency,:ci_exchange_rate], table:true %>
            </table>
          </td>
        </tr>
      </tbody>
    </table>
    <%fields = ModelField.viewable_model_fields(current_user, [:cil_part_number,:cil_po_number,:cil_customer_reference, :cil_units,:cil_uom,:ent_unit_price,:cil_value,:cil_adjustments_amount,:cil_country_origin_code,:ent_state_origin_code,:cil_country_export_code,:ent_state_export_code])%>
    <table class='table table-condensed table-bordered'>
      <thead>
        <tr>
          <%= model_field_labels fields, table: true, heading: true %>
        </tr>
      </thead>
      <tbody>
        <%ci.commercial_invoice_lines.each do |line|%>
          <tr class='hover ci_line'>
          <%fields.each_with_index do |f,i|%>
              <%= show_model_fields line, f, editor_only: true, table: true %>
            <%end%>
          </tr>
          <% if line.commercial_invoice_tariffs.count > 0%>
            <tr>
              <td>&nbsp;</td>
              <td colspan='<%=fields.length - 1%>' style='font-size:111%;'>
                <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:cit_hts_code,:cit_duty_amount,:cit_entered_value,:cit_duty_rate,:cit_spi_primary,:ent_tariff_provision,
                  :cit_classification_qty_1,:cit_classification_uom_1,:ent_value_for_duty_code,:ent_gst_rate_code,:ent_gst_amount,
                  :ent_sima_amount,:ent_excise_amount,:ent_excise_rate_code, :cit_tariff_description], :lines=>line.commercial_invoice_tariffs,
                  :overrides=>{:cit_hts_code=>lambda {|mf,line| show_tariff(line.hts_code,line.entry.import_country_id,true)}}}%>
              </td>
            </tr>
          <% end %>
        <%end%>
      </tbody>
    </table>
    <hr />
  <%end%>
<%else%>
  <h3>More than 200 commercial invoice lines exist.  Please <a href="<%=entry_path(@entry, format: :xlsx)%>">download</a> the entry data or use the <a href='/entries'>search module</a> to report on commercial invoice details.</h3>
<%end%>
<%if show_broker_invoices%>
  <a name='b_invoices'></a>
  <div class='quick_jump'><span class='qj_label'>Jump To:</span>
    <a href='#ent_header'>Top</a> |
    <a href='#c_invoices'>Commercial Invoices</a>
  </div>
  <h1>Broker Invoices</h1>
  <%fields = [:bi_invoice_number,:bi_invoice_date,:bi_suffix,:bi_invoice_total]%>
  <table class='detail_table'>
    <thead>
      <tr>
        <%= model_field_labels fields, table: true, heading: true  %>
      </tr>
    </thead>
    <tbody>
      <%@entry.broker_invoices.each do |line|%>
        <%if line.can_view? current_user %>
          <tr class='hover'>
            <%= show_model_fields line, fields, table: true, editor_only: true, bi_invoice_number: {wrap_with: lambda{|mf, value| link_to(value, "#bi_#{line.id}")}} %>
          </tr>
        <% end %>
      <%end%>
    </tbody>
  </table>
  <hr />
  <%@entry.broker_invoices.each do |bi|%>
    <% if bi.can_view? current_user%>
      <a name='bi_<%=bi.id%>'></a>
      <table class='ent_columns'>
        <tbody>
          <tr>
            <td colspan='2'>
              <h3><%= model_field_labels :bi_invoice_date %><%= show_model_fields bi, :bi_invoice_date, editor_only: true, wrap_with: lambda {|mf, value| (" - " + value).html_safe} %></h3>
            </td>
          </tr>
          <tr>
            <td style='width:50%;'>
              <table>
                <%= show_model_fields bi, [:bi_invoice_number,:bi_suffix,:bi_invoice_total,:bi_currency], table:true %>
              </table>
            </td>
            <td style='width:50%;'>
              <table>
                <%= show_model_fields bi, [:bi_to_name,:bi_to_add1,:bi_to_add2,:bi_to_city,:bi_to_state,:bi_to_zip,:bi_to_country_iso], table:true %>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
      <%=render :partial=>'shared/detail_table', :locals=>{:fields=>[:bi_line_charge_code,:bi_line_charge_description,:bi_line_charge_amount,:bi_line_vendor_name,:bi_line_vendor_reference,:bi_line_charge_type,:bi_line_hst_percent],:lines=>bi.broker_invoice_lines}%>
      <%=render :partial => 'shared/integration_file_link', :locals => {:obj => bi, :user => current_user, :exclude_send_button => true} %>
    <% end %>
  <%end%>
<%end%>
<%=render :partial => 'shared/attachments', :locals => {:attachable => @entry, :width=>"wide"} %>
<br />
<%=render :partial => 'shared/integration_file_link', :locals => {:obj => @entry, :user => current_user} %>
