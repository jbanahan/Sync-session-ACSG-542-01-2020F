<%
entries = Entry.search_secure(current_user,Entry.where(entry_port_code:params[:port_code])).where(Entry.search_where_by_company_id(params[:importer_id]))
newest_entry = entries.order('updated_at DESC').first
newest_port = Port.order('updated_at DESC').first
params[:page] ||= '1'
%>
<%-cache ['v1','entries_by_port',newest_entry,newest_port,params[:page]] do-%>
  <%# do pagination here so it's inside the cache wrapper%>
  <%-pg_entries = entries.order('ifnull(release_date,"2999-01-01") DESC').paginate(page:params[:page],per_page:30)-%>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <h1>Entries By Port</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8 col-md-offset-2 text-center">
        <%-cache ['v1','port_select',newest_port] do -%>
          <select id='portselect' class='form-control form-lg'>
            <%=grouped_options_for_select Port.grouped_by_entry_country%>
          </select>
        <%-end-%>
      </div>
    </div>
    <div class='row'>
      <div class='col-md-8 col-md-offset-2'>
        <div class='panel panel-default text-center'>
          <%=page_entries_info pg_entries%>
        </div>
      </div>
    </div>
  </div>
  <%-fields_to_use = [:ent_entry_num,:ent_filed_date,:ent_release_date,:ent_entered_value,:ent_customer_references,:ent_po_numbers]-%>
  <table class="table table-striped table-bordered table-condensed table-hover">
    <thead>
      <tr>
        <th>&nbsp;</th>
        <%-fields_to_use.each do |f|-%>
        <th><%=ModelField.find_by_uid(f).label(false)%></th>
        <%-end-%>
      </tr>
    </thead>
    <tbody>
      <%-pg_entries.each do |ent|-%>
      <tr>
        <td><%=link_to 'View', ent, :class=>'btn btn-xs btn-default'%></td>
        <%-fields_to_use.each do |f|-%>
          <td><%=ModelField.find_by_uid(f).process_export(ent,current_user)%></td>
        <%-end-%>
      </tr>
      <%-end-%>
    </tbody>
  </table>
<script type='text/javascript'> <%# needs to be javascript so it executes inside of cache, can't use content_for%>
  $(document).ready(function() {
    $('#nav-action-bar').append("<form class='navbar-form pull-right btn-group' id='browsenav'></form>")
    Chain.addPagination('#browsenav','<%=request.original_fullpath.split("?").first%>',<%=params[:page]%>,<%=pg_entries.total_pages%>);
    $("#portselect").val('<%=params[:port_code]%>');
    $("#portselect").on('change',function() {
      base_url = '<%=request.original_fullpath.split("entry_port").first%>';
      window.location = base_url+'entry_port/'+$(this).val();
    });
  });
</script>
<%-end-%>
