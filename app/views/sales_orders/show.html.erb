<%content_for :javascript do %>
$(function() {
  <%if @sales_order.can_edit?(current_user)%>
  $("#btn_edit").click(function() {
    window.location = '<%=url_for edit_sales_order_path(@sales_order)%>';
  });
  OpenChain.addClickMap('e','Edit','btn_edit');
  <%end%>
  $("#mod_subscriptions").dialog({autoOpen:false,title:'Subscriptions',
      buttons:{"Subscribe":function() {$("#frm_sub").submit();}}
    });
  $("#btn_subscriptions")
    .click(function() {
      $("#mod_subscriptions").dialog('open');
    });
  $("#mod_edit_line").dialog({autoOpen:false,title:'Edit Line',width:'auto',
    buttons:{"Save":function() {$("#frm_edit_line").submit();},
             "Cancel":function() {window.location = '<%=sales_order_path(@sales_order)%>';}}
  });
  $("#btn_add_line").click(function() {
    $("#mod_edit_line").dialog('open');
  });  
  <% if @sales_order.can_edit?(current_user) && !@line.nil? %>
    $("#mod_edit_line").dialog('open');
    OpenChain.addClickMap('r','Add Product','btn_add_line');
  <% end %>
  $("#edit_line_product").change(function() {
    if($(this).val().length>0) {
      $("#edit_line_uom").html("<span style='font-size:80%;'>...loading...</span>");
      getProductUOM($(this).val(),function(uom) {
        $("#edit_line_uom").html(uom);
      });
    }
  });
  <% if current_user.company.master && !@sales_order.locked? %>
    OpenChain.addClickMap('d','Delete','btn_delete');
  <%end%>
  $("#btn_delete_redirect").click(function() {$("#btn_delete").click();});
});
<%end%>
<%content_for :action_bar do%>
  <%if @sales_order.can_edit?(current_user)%><button id='btn_edit'>Edit</button><%end%>
  <button class='btn_link' link_to='<%=sales_orders_path%>' key_map='b'>Back To Search</button>
  <% if current_user.company.master && !@sales_order.locked? %>
    <button id='btn_delete_redirect'>Delete</button>
  <% end %>
  <% if @line.nil? && @sales_order.can_edit?(current_user) %>
    <button id='btn_add_line'>Add Product</button>
  <% end %>
  <button class='btn_link' link_to='<%=history_sales_order_path(@sales_order)%>' key_map='h'>History</button>
  <button id='btn_subscriptions'>Subscriptions<%=ItemChangeSubscription.count(:conditions => {:sales_order_id => @sales_order.id, :user_id => current_user.id}) == 0 ? '' : "*"%></button>
<%end%>
<%=render :partial=>'shared/attachments',:locals=>{:attachable=>@sales_order}%>
<div class='next_to_attachments'>
<table class='detail_table'>
<tbody><tr><td>
  <table>
    <%=show_model_fields @sales_order, [:sale_order_number, :sale_order_date, :sale_cust_name], table: true %>
    <%=show_custom_fields @sales_order, {:table=>true} %>
  </table>
</td></tr></tbody>
</table>
</div>
<div>
      
<table class="detail_table">
  <thead>
    <th>&nbsp;</th>
    <%= model_field_labels([:soln_line_number, :prod_name, :soln_ordered_qty],  table: true, heading:true) %>
    <th>Qty On Delivery</th>
    <%= model_field_labels([:prod_uom, :soln_ppu],  table: true, heading:true) %>
    <th>Total Price</th>
    <th>&nbsp;</th>
  </thead>

  <% @sales_order.sales_order_lines.each do |line| %>
        <tr class='hover'>
          <% line.set_line_number if line.line_number.nil? %>
          <% if @sales_order.can_edit?(current_user) && !@sales_order.locked? %>
            <td><button class='btn_link btn btn-sm' link_to='<%=edit_sales_order_sales_order_line_path(@sales_order,line)%>'>edit</button></td>
          <% end %>
          <%= show_model_fields line, :soln_line_number, table: true, editor_only: true %>  
          <% if ModelField.find_by_uid(:prod_name).can_view?(current_user) && line.product.try(:can_view?, current_user) %>
            <td><%= link_to ModelField.find_by_uid(:prod_name).process_export(line.product, User.current), product_path(line.product) %></td>
          <% end %>
          <%= show_model_fields line, :soln_ordered_qty, table: true, editor_only: true %>
          <td class="has_numeric"><%= number_with_precision(line.delivery_qty, precision: 5, strip_insignificant_zeros: true)%></td>
          <%= show_model_fields(line.product, :prod_uom, table: true, editor_only: true) %>
          <%= show_model_fields line, :soln_ordered_qty, table: true, editor_only: true %>
          <td class="has_numeric"><%= line.price_per_unit.nil? || line.quantity.nil? ? '' : number_with_precision(line.price_per_unit * line.quantity, precision: 5, strip_insignificant_zeros: true) %></td>
          <td>
            <% if @sales_order.can_edit?(current_user) && !@sales_order.locked?%>
              <%= link_to 'Delete', sales_order_sales_order_line_path(@sales_order,line) , :confirm => 'Are you sure?', :method => :delete %>
            <% end %> 
          </td>
        </tr>
  <% end %>
</table>
</div>
<%=render :partial => 'shared/comments', :locals => {:commentable => @sales_order} %>
<% form_line = @line.nil? ? @sales_order.sales_order_lines.build : @line %>
<% form_line.default_line_number %>
<div id='mod_edit_line' style='display:none;'>
  <%= form_for([@sales_order, form_line], :html=>{:id=>"frm_edit_line"}) do |f| %>
    <table>
      <%= show_model_fields f, :soln_line_number, table: true, soln_line_number: {style: "width: 3em"} %>
      <% if form_line.new_record? %>
        <%= show_model_fields(f, :soln_prod_id, table: true) do |mf, field_name, value, attrs|
              attrs[:select_options] = options_from_collection_for_select(@products, :id, :unique_identifier, value)
              attrs[:prompt] = "Select a product"
              attrs[:id] = "edit_line_product"
              model_select_field_tag(field_name, mf, value, attrs)
            end %>
      <% else %>
        <%= show_model_fields form_line.product, :prod_name, table: true %>
      <% end %>
      <%= show_model_fields f, :soln_ordered_qty, table: true, soln_ordered_qty: {style: "width: 5em"} %>
      <% prod = form_line.product ? form_line.product : Product.new %>
      <%= show_model_fields prod, :prod_uom, {table:true, wrap_with: lambda {|mf, editor| content_tag(:span, editor, :id=>"edit_line_uom")}} %>
      <%= show_model_fields f, :soln_ppu, table: true, soln_ppu: {style: "width: 5em"} %>
    </table>
  <% end %>
</div>
<div id='mod_subscriptions' style='display:none;'>
  <% 
  change_subs = ItemChangeSubscription.where({:sales_order_id => @sales_order.id, :user_id => current_user.id})
  if change_subs.length == 0
   @ics = @sales_order.item_change_subscriptions.build
   @ics.user = current_user 
  else
   @ics = change_subs[0]
  end 
 %>
 <%= form_for @ics, :html => {:id=>'frm_sub'} do |ics| %>
    <%= ics.hidden_field :user_id %>
    <%= ics.hidden_field :sales_order_id %>
    <%= ics.check_box :app_message %> Message<br />
    <%= ics.check_box :email %> Email<br />
 <% end %>
</div>
<div style='display:none;'>
  <%= button_to('Delete', sales_order_path(@sales_order),:method => :delete, :confirm => "Are you sure?", :id => "btn_delete") %>
</div>
